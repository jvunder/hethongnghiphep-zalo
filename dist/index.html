<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content:" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <title>Quáº£n lÃ½ Nghá»‰ phÃ©p</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    .app-container { padding-bottom: 70px; }

    /* Pages */
    .page { display: none; }
    .page.active { display: block; }

    /* Login Page - Full screen overlay */
    #login-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      min-height: 100vh;
      display: none;
      flex-direction: column;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      z-index: 1000;
    }
    #login-page.active { display: flex; }
    .login-logo {
      text-align: center;
      margin-bottom: 40px;
    }
    .login-logo-icon { font-size: 64px; }
    .login-logo-text { color: white; font-size: 24px; font-weight: bold; margin-top: 10px; }
    .login-card {
      background: white;
      padding: 30px 24px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .login-title { font-size: 20px; font-weight: 600; text-align: center; margin-bottom: 24px; color: #1a1a1a; }
    .login-error {
      background: #fee2e2;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
      display: none;
    }
    .login-error.show { display: block; }

    /* Header */
    .header {
      background: #2563eb;
      color: white;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logout {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    /* Cards */
    .card {
      background: white;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Menu items */
    .menu-item {
      background: white;
      padding: 18px 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.1s;
    }
    .menu-item:active { transform: scale(0.98); }
    .menu-icon { font-size: 28px; margin-right: 15px; }
    .menu-text { font-size: 16px; font-weight: 500; flex: 1; }
    .menu-arrow { color: #9ca3af; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .stat-value { font-size: 24px; font-weight: bold; color: #2563eb; }
    .stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn-primary { background: #2563eb; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn:active { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 8px 12px; font-size: 14px; width: auto; margin: 0; }
    .btn-row { display: flex; gap: 8px; margin-top: 12px; }

    /* Form */
    .form-group { margin-bottom: 16px; }
    .label { font-size: 14px; font-weight: 600; margin-bottom: 8px; display: block; color: #374151; }
    .input, .select, .textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      background: white;
    }
    .textarea { min-height: 80px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus {
      outline: none;
      border-color: #2563eb;
    }

    /* Time options */
    .time-options { display: flex; gap: 8px; margin-bottom: 16px; }
    .time-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      cursor: pointer;
    }
    .time-btn.active { border-color: #2563eb; background: #eff6ff; color: #2563eb; }

    /* Status badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-approved { background: #dcfce7; color: #166534; }
    .badge-rejected { background: #fee2e2; color: #991b1b; }

    /* Status cards */
    .status-card {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .status-success { background: #dcfce7; color: #166534; }
    .status-warning { background: #fef3c7; color: #92400e; }
    .status-error { background: #fee2e2; color: #991b1b; }
    .status-pending { background: #f3f4f6; color: #6b7280; }

    /* List items */
    .list-item {
      background: white;
      padding: 14px;
      margin-bottom: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .list-item-title { font-weight: 600; }
    .list-item-subtitle { font-size: 13px; color: #6b7280; }
    .text-small { font-size: 13px; color: #6b7280; margin-top: 4px; }
    .text-orange { color: #ea580c; }

    /* Empty state */
    .empty { text-align: center; padding: 40px 20px; color: #9ca3af; }

    /* Section title */
    .section-title { font-size: 16px; font-weight: 600; margin: 20px 0 12px; color: #374151; }

    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
    }
    .tab.active { background: #2563eb; color: white; }

    /* Bottom navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      cursor: pointer;
      color: #9ca3af;
      font-size: 11px;
    }
    .nav-item.active { color: #2563eb; }
    .nav-icon { font-size: 22px; margin-bottom: 2px; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: flex-end;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: white;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
      border-radius: 16px 16px 0 0;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }

    /* Info box */
    .info-box {
      background: #e0f2fe;
      padding: 15px;
      border-radius: 8px;
      margin: 16px 0;
    }
    .info-box p { margin: 5px 0; font-size: 14px; color: #0369a1; }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { background: #f9fafb; font-weight: 600; color: #374151; }

    /* Toast notification */
    #toast {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 14px;
      border-radius: 8px;
      text-align: center;
      z-index: 300;
    }
  </style>
</head>
<body>

  <!-- ==================== LOGIN PAGE ==================== -->
  <div id="login-page" class="active">
    <div class="login-logo">
      <div class="login-logo-icon">ğŸ¢</div>
      <div class="login-logo-text">Há»‡ thá»‘ng Quáº£n lÃ½ Nghá»‰ phÃ©p<br/>è¯·å‡ç®¡ç†ç³»ç»Ÿ</div>
    </div>
    <div class="login-card">
      <div class="login-title">ÄÄƒng nháº­p / ç™»å½•</div>
      <div id="login-error" class="login-error"></div>
      <div class="form-group">
        <label class="label">TÃªn Ä‘Äƒng nháº­p / ç”¨æˆ·å</label>
        <input type="text" id="login-username" class="input" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p / è¯·è¾“å…¥ç”¨æˆ·å" />
      </div>
      <div class="form-group">
        <label class="label">Máº­t kháº©u / å¯†ç </label>
        <input type="password" id="login-password" class="input" placeholder="Nháº­p máº­t kháº©u / è¯·è¾“å…¥å¯†ç " />
      </div>
      <button class="btn btn-primary" onclick="handleLogin()">ÄÄƒng nháº­p / ç™»å½•</button>
    </div>
  </div>

  <!-- ==================== APP CONTAINER ==================== -->
  <div id="app-container" class="app-container" style="display:none;">

    <!-- ==================== EMPLOYEE PAGES ==================== -->

    <!-- Employee Home -->
    <div id="page-emp-home" class="page" style="padding:0;">
      <div class="header">
        <span id="emp-header-name">Xin chÃ o / ä½ å¥½</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <!-- Today's meal status card -->
        <div id="emp-meal-card" class="card" style="margin-bottom:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-size:14px; color:#6b7280;">BÃ¡o cÆ¡m hÃ´m nay / ä»Šæ—¥è®¢é¤</div>
              <div id="emp-meal-status" style="font-size:18px; font-weight:600; margin-top:4px;">ChÆ°a bÃ¡o / æœªç™»è®°</div>
            </div>
            <div id="emp-meal-icon" style="font-size:32px;">ğŸš</div>
          </div>
        </div>

        <div class="menu-item" onclick="showEmpPage('leave')">
          <span class="menu-icon">ğŸ“…</span>
          <span class="menu-text">Xin nghá»‰ phÃ©p / è¯·å‡ç”³è¯·</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showEmpPage('meal')">
          <span class="menu-icon">ğŸš</span>
          <span class="menu-text">BÃ¡o cÆ¡m / è®¢é¤</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showEmpPage('history')">
          <span class="menu-icon">ğŸ“‹</span>
          <span class="menu-text">Lá»‹ch sá»­ nghá»‰ phÃ©p / è¯·å‡è®°å½•</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showEmpPage('password')">
          <span class="menu-icon">ğŸ”’</span>
          <span class="menu-text">Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </span>
          <span class="menu-arrow">â€º</span>
        </div>
      </div>
    </div>

    <!-- Employee Leave Request -->
    <div id="page-emp-leave" class="page" style="padding:0;">
      <div class="header">
        <span>Xin nghá»‰ phÃ©p / è¯·å‡ç”³è¯·</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card">
          <div class="form-group">
            <label class="label">NgÃ y nghá»‰ / è¯·å‡æ—¥æœŸ</label>
            <input type="date" id="leave-date" class="input" onchange="checkLeaveDate()" />
          </div>

          <!-- Late leave warning - shows when selecting today or past -->
          <div id="late-leave-warning" class="status-card status-error" style="display:none; margin-bottom:16px;">
            ğŸš¨ <strong>BÃ¡o nghá»‰ Ä‘á»™t xuáº¥t! / ä¸´æ—¶è¯·å‡!</strong><br>
            <small>Pháº£i bÃ¡o trÆ°á»›c Ä‘Ãªm hÃ´m trÆ°á»›c. BÃ¡o hÃ´m nay = KHÃ”NG Ká»ŠP cáº¯t cÆ¡m!<br/>å¿…é¡»æå‰ä¸€å¤©æ™šä¸Šç”³è¯·ã€‚å½“å¤©ç”³è¯·=æ¥ä¸åŠå–æ¶ˆè®¢é¤!</small>
          </div>

          <label class="label">Thá»i gian / æ—¶é—´</label>
          <div class="time-options">
            <button class="time-btn active" onclick="selectTime('full', this)">Cáº£ ngÃ y / å…¨å¤©</button>
            <button class="time-btn" onclick="selectTime('morning', this)">Buá»•i sÃ¡ng / ä¸Šåˆ</button>
            <button class="time-btn" onclick="selectTime('afternoon', this)">Buá»•i chiá»u / ä¸‹åˆ</button>
          </div>

          <!-- Meal cancel option - shows when half day selected AND not late -->
          <div id="meal-cancel-option" style="display:none; margin-bottom:16px;">
            <label class="label">Cáº¯t cÆ¡m? / å–æ¶ˆè®¢é¤?</label>
            <div class="time-options">
              <button class="time-btn" id="btn-cancel-meal-yes" onclick="selectMealCancel(true, this)">CÃ³, cáº¯t cÆ¡m / æ˜¯,å–æ¶ˆ</button>
              <button class="time-btn active" id="btn-cancel-meal-no" onclick="selectMealCancel(false, this)">KhÃ´ng, váº«n Äƒn / å¦,ä¿ç•™</button>
            </div>
          </div>

          <!-- Auto cancel meal notice - shows when full day selected AND not late -->
          <div id="meal-auto-cancel-notice" class="status-card status-warning" style="margin-bottom:16px;">
            âš ï¸ Nghá»‰ cáº£ ngÃ y sáº½ <strong>tá»± Ä‘á»™ng cáº¯t cÆ¡m</strong> / å…¨å¤©è¯·å‡å°†<strong>è‡ªåŠ¨å–æ¶ˆè®¢é¤</strong>
          </div>

          <div class="form-group">
            <label class="label">LÃ½ do / åŸå› </label>
            <textarea id="leave-reason" class="textarea" placeholder="Nháº­p lÃ½ do nghá»‰ phÃ©p... / è¯·è¾“å…¥è¯·å‡åŸå› ..."></textarea>
          </div>

          <button class="btn btn-primary" onclick="submitLeave()">Gá»­i Ä‘Æ¡n nghá»‰ phÃ©p / æäº¤ç”³è¯·</button>
        </div>

        <div class="info-box">
          <p><strong>Quy Ä‘á»‹nh bÃ¡o nghá»‰: / è¯·å‡è§„å®š:</strong></p>
          <p>â€¢ BÃ¡o nghá»‰ <strong>muá»™n nháº¥t Ä‘Ãªm hÃ´m trÆ°á»›c</strong> / æœ€æ™š<strong>å‰ä¸€å¤©æ™šä¸Š</strong>ç”³è¯·</p>
          <p>â€¢ Nghá»‰ cáº£ ngÃ y â†’ Tá»± Ä‘á»™ng cáº¯t cÆ¡m / å…¨å¤©è¯·å‡ â†’ è‡ªåŠ¨å–æ¶ˆè®¢é¤</p>
          <p>â€¢ Nghá»‰ ná»­a ngÃ y â†’ Chá»n cÃ³ cáº¯t cÆ¡m hay khÃ´ng / åŠå¤©è¯·å‡ â†’ é€‰æ‹©æ˜¯å¦å–æ¶ˆè®¢é¤</p>
          <p>â€¢ BÃ¡o nghá»‰ Ä‘á»™t xuáº¥t (cÃ¹ng ngÃ y) â†’ KhÃ´ng ká»‹p cáº¯t cÆ¡m / ä¸´æ—¶è¯·å‡(å½“å¤©) â†’ æ¥ä¸åŠå–æ¶ˆè®¢é¤</p>
        </div>
      </div>
    </div>

    <!-- Employee Meal Registration -->
    <div id="page-emp-meal" class="page" style="padding:0;">
      <div class="header">
        <span>BÃ¡o cÆ¡m / è®¢é¤</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card">
          <div class="section-title" style="margin-top:0">HÃ´m nay / ä»Šå¤© (<span id="today-date"></span>)</div>
          <div id="meal-status"></div>

          <!-- Cancel meal section - only show when not already cancelled -->
          <div id="cancel-meal-section">
            <div class="form-group">
              <label class="label">LÃ½ do há»§y cÆ¡m / å–æ¶ˆåŸå› </label>
              <input type="text" id="cancel-reason" class="input" placeholder="VD: Ä‚n ngoÃ i, cÃ³ viá»‡c báº­n... / ä¾‹å¦‚:å¤–å‡ºå°±é¤,æœ‰äº‹..." />
            </div>
            <button class="btn btn-danger" onclick="cancelMeal()">âŒ Há»§y cÆ¡m hÃ´m nay / å–æ¶ˆä»Šæ—¥è®¢é¤</button>
          </div>

          <!-- Re-register button - only show when cancelled -->
          <div id="reregister-meal-section" style="display:none;">
            <button class="btn btn-success" onclick="reregisterMeal()">ğŸš ÄÄƒng kÃ½ láº¡i cÆ¡m / é‡æ–°è®¢é¤</button>
          </div>
        </div>

        <div class="info-box">
          <p><strong>Quy Ä‘á»‹nh bÃ¡o cÆ¡m: / è®¢é¤è§„å®š:</strong></p>
          <p>â€¢ Äi lÃ m = Máº·c Ä‘á»‹nh <strong>cÃ³ cÆ¡m</strong> / ä¸Šç­ = é»˜è®¤<strong>è®¢é¤</strong></p>
          <p>â€¢ Chá»‰ cáº§n bÃ¡o khi muá»‘n <strong>há»§y cÆ¡m</strong> / åªéœ€åœ¨<strong>å–æ¶ˆè®¢é¤</strong>æ—¶ç”³æŠ¥</p>
          <p>â€¢ Nghá»‰ cáº£ ngÃ y = Tá»± Ä‘á»™ng cáº¯t cÆ¡m / å…¨å¤©è¯·å‡ = è‡ªåŠ¨å–æ¶ˆè®¢é¤</p>
        </div>
      </div>
    </div>

    <!-- Employee Leave History -->
    <div id="page-emp-history" class="page" style="padding:0;">
      <div class="header">
        <span>Lá»‹ch sá»­ nghá»‰ phÃ©p / è¯·å‡è®°å½•</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div id="emp-leave-history"></div>
      </div>
    </div>

    <!-- Employee Change Password -->
    <div id="page-emp-password" class="page" style="padding:0;">
      <div class="header">
        <span>Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card">
          <div class="form-group">
            <label class="label">Máº­t kháº©u hiá»‡n táº¡i / å½“å‰å¯†ç </label>
            <input type="password" id="current-password" class="input" placeholder="Nháº­p máº­t kháº©u hiá»‡n táº¡i / è¯·è¾“å…¥å½“å‰å¯†ç " />
          </div>
          <div class="form-group">
            <label class="label">Máº­t kháº©u má»›i / æ–°å¯†ç </label>
            <input type="password" id="new-password" class="input" placeholder="Nháº­p máº­t kháº©u má»›i / è¯·è¾“å…¥æ–°å¯†ç " />
          </div>
          <div class="form-group">
            <label class="label">XÃ¡c nháº­n máº­t kháº©u má»›i / ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirm-password" class="input" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i / è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " />
          </div>
          <button class="btn btn-primary" onclick="changePassword()">Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </button>
        </div>
      </div>
    </div>

    <!-- ==================== MANAGER PAGES ==================== -->

    <!-- Manager Home -->
    <div id="page-mgr-home" class="page" style="padding:0;">
      <div class="header">
        <span id="mgr-header-name">Quáº£n lÃ½ / ç®¡ç†</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-employees">0</div>
            <div class="stat-label">NhÃ¢n viÃªn / å‘˜å·¥</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-label">Tá»•ng Ä‘Æ¡n nghá»‰ / è¯·å‡æ€»æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-today-leave">0</div>
            <div class="stat-label">Nghá»‰ hÃ´m nay / ä»Šæ—¥è¯·å‡</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-today-meal">0</div>
            <div class="stat-label">ÄÄƒng kÃ½ cÆ¡m / è®¢é¤</div>
          </div>
        </div>

        <div class="menu-item" onclick="showMgrPage('leaves')">
          <span class="menu-icon">ğŸ“‹</span>
          <span class="menu-text">Theo dÃµi nghá»‰ phÃ©p / æŸ¥çœ‹è¯·å‡</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showMgrPage('meals')">
          <span class="menu-icon">ğŸš</span>
          <span class="menu-text">Quáº£n lÃ½ bÃ¡o cÆ¡m / è®¢é¤ç®¡ç†</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showMgrPage('attendance')">
          <span class="menu-icon">ğŸ“Š</span>
          <span class="menu-text">Cháº¥m cÃ´ng / è€ƒå‹¤</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showMgrPage('employees')">
          <span class="menu-icon">ğŸ‘¥</span>
          <span class="menu-text">Quáº£n lÃ½ nhÃ¢n viÃªn / å‘˜å·¥ç®¡ç†</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showMgrPage('password')">
          <span class="menu-icon">ğŸ”’</span>
          <span class="menu-text">Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </span>
          <span class="menu-arrow">â€º</span>
        </div>
      </div>
    </div>

    <!-- Manager Leave Approval -->
    <div id="page-mgr-leaves" class="page" style="padding:0;">
      <div class="header">
        <span>Quáº£n lÃ½ nghá»‰ phÃ©p / è¯·å‡ç®¡ç†</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <!-- Main tabs: Duyá»‡t Ä‘Æ¡n / BÃ¡o cÃ¡o -->
        <div class="tabs" style="margin-bottom:16px;">
          <div class="tab active" onclick="switchLeaveMainTab('approval', this)">Theo dÃµi / æŸ¥çœ‹</div>
          <div class="tab" onclick="switchLeaveMainTab('report', this)">BÃ¡o cÃ¡o / æŠ¥è¡¨</div>
        </div>

        <!-- Approval Section -->
        <div id="leave-approval-section">
          <div class="tabs">
            <div class="tab active" onclick="filterLeaves('approved', this)">ÄÃ£ duyá»‡t / å·²æ‰¹å‡†</div>
            <div class="tab" onclick="filterLeaves('rejected', this)">ÄÃ£ tá»« chá»‘i / å·²æ‹’ç»</div>
          </div>
          <div id="mgr-leave-list"></div>
        </div>

        <!-- Report Section -->
        <div id="leave-report-section" style="display:none;">
          <!-- Employee filter dropdown -->
          <div class="card" style="margin-bottom:16px;">
            <div class="form-group" style="margin-bottom:0;">
              <label class="label">Chá»n nhÃ¢n viÃªn / é€‰æ‹©å‘˜å·¥</label>
              <select id="leave-report-employee" class="select" onchange="onLeaveEmployeeFilterChange()">
                <option value="all">-- Táº¥t cáº£ nhÃ¢n viÃªn / å…¨éƒ¨å‘˜å·¥ --</option>
              </select>
            </div>
          </div>

          <!-- Report tabs: Day/Week/Month -->
          <div class="tabs" style="margin-bottom:16px;">
            <div class="tab active" onclick="switchLeaveReportTab('day', this)">Theo ngÃ y / æŒ‰æ—¥</div>
            <div class="tab" onclick="switchLeaveReportTab('week', this)">Theo tuáº§n / æŒ‰å‘¨</div>
            <div class="tab" onclick="switchLeaveReportTab('month', this)">Theo thÃ¡ng / æŒ‰æœˆ</div>
          </div>

          <!-- Day Report -->
          <div id="leave-report-day">
            <div class="card">
              <div class="form-group" style="margin-bottom:0;">
                <label class="label">Chá»n ngÃ y / é€‰æ‹©æ—¥æœŸ</label>
                <input type="date" id="leave-report-date" class="input" onchange="renderLeaveReportDay()" />
              </div>
            </div>

            <div class="stats-grid" style="margin-top:16px;">
              <div class="stat-card">
                <div class="stat-value" id="stat-leave-day-total">0</div>
                <div class="stat-label">Tá»•ng nghá»‰ / è¯·å‡äººæ•°</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat-leave-day-full">0</div>
                <div class="stat-label">Cáº£ ngÃ y / å…¨å¤©</div>
              </div>
            </div>

            <div class="section-title">Danh sÃ¡ch nghá»‰ phÃ©p / è¯·å‡åå•</div>
            <div id="leave-day-list"></div>
          </div>

          <!-- Week Report -->
          <div id="leave-report-week" style="display:none;">
            <div class="card">
              <div class="form-group" style="margin-bottom:0;">
                <label class="label">Chá»n tuáº§n / é€‰æ‹©å‘¨</label>
                <input type="week" id="leave-report-week-input" class="input" onchange="renderLeaveReportWeek()" />
              </div>
            </div>

            <div class="card" style="margin-top:16px; background:#fef3c7;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-size:14px; color:#92400e;">Tá»•ng tuáº§n / å‘¨åˆè®¡</div>
                  <div id="leave-week-date-range" style="font-size:13px; color:#b45309;"></div>
                </div>
                <div style="text-align:right;">
                  <div id="stat-leave-week-total" style="font-size:28px; font-weight:bold; color:#b45309;">0</div>
                  <div style="font-size:12px; color:#92400e;">ngÃ y nghá»‰ / å¤©</div>
                </div>
              </div>
            </div>

            <div class="section-title">Chi tiáº¿t theo ngÃ y / æ¯æ—¥æ˜ç»†</div>
            <div id="leave-week-list"></div>
          </div>

          <!-- Month Report -->
          <div id="leave-report-month" style="display:none;">
            <div class="card">
              <div class="form-group" style="margin-bottom:0;">
                <label class="label">Chá»n thÃ¡ng / é€‰æ‹©æœˆä»½</label>
                <input type="month" id="leave-report-month-input" class="input" onchange="renderLeaveReportMonth()" />
              </div>
            </div>

            <div class="card" style="margin-top:16px; background:#fef3c7;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-size:14px; color:#92400e;">Tá»•ng thÃ¡ng / æœˆåˆè®¡</div>
                  <div id="leave-month-name" style="font-size:13px; color:#b45309;"></div>
                </div>
                <div style="text-align:right;">
                  <div id="stat-leave-month-total" style="font-size:28px; font-weight:bold; color:#b45309;">0</div>
                  <div style="font-size:12px; color:#92400e;">ngÃ y nghá»‰ / å¤©</div>
                </div>
              </div>
            </div>

            <div class="section-title">Thá»‘ng kÃª theo nhÃ¢n viÃªn / å‘˜å·¥ç»Ÿè®¡</div>
            <div id="leave-month-emp-list"></div>

            <div class="section-title">Chi tiáº¿t theo tuáº§n / æ¯å‘¨æ˜ç»†</div>
            <div id="leave-month-weeks"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manager Employees -->
    <div id="page-mgr-employees" class="page" style="padding:0;">
      <div class="header">
        <span>Quáº£n lÃ½ nhÃ¢n viÃªn / å‘˜å·¥ç®¡ç†</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <button class="btn btn-primary" onclick="openAddEmployeeModal()">+ ThÃªm nhÃ¢n viÃªn / æ·»åŠ å‘˜å·¥</button>
        <div class="section-title">Danh sÃ¡ch nhÃ¢n viÃªn / å‘˜å·¥åå•</div>
        <div id="mgr-employee-list"></div>
      </div>
    </div>

    <!-- Manager Meals -->
    <div id="page-mgr-meals" class="page" style="padding:0;">
      <div class="header">
        <span>Quáº£n lÃ½ bÃ¡o cÆ¡m / è®¢é¤ç®¡ç†</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <!-- Tabs for Day/Week/Month -->
        <div class="tabs" style="margin-bottom:16px;">
          <div class="tab active" onclick="switchMealReportTab('day', this)">Theo ngÃ y / æŒ‰æ—¥</div>
          <div class="tab" onclick="switchMealReportTab('week', this)">Theo tuáº§n / æŒ‰å‘¨</div>
          <div class="tab" onclick="switchMealReportTab('month', this)">Theo thÃ¡ng / æŒ‰æœˆ</div>
        </div>

        <!-- Day Report -->
        <div id="meal-report-day">
          <div class="card">
            <div class="form-group" style="margin-bottom:0;">
              <label class="label">Chá»n ngÃ y / é€‰æ‹©æ—¥æœŸ</label>
              <input type="date" id="meal-mgr-date" class="input" onchange="renderMgrMeals()" />
            </div>
          </div>

          <div class="stats-grid" style="margin-top:16px;">
            <div class="stat-card">
              <div class="stat-value" id="stat-meal-registered">0</div>
              <div class="stat-label">ÄÄƒng kÃ½ cÆ¡m / è®¢é¤</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="stat-meal-cancelled">0</div>
              <div class="stat-label">Cáº¯t cÆ¡m / å–æ¶ˆ</div>
            </div>
          </div>

          <div class="section-title">Danh sÃ¡ch bÃ¡o cÆ¡m / è®¢é¤åå•</div>
          <div id="mgr-meal-list"></div>
        </div>

        <!-- Week Report -->
        <div id="meal-report-week" style="display:none;">
          <div class="card">
            <div class="form-group" style="margin-bottom:0;">
              <label class="label">Chá»n tuáº§n / é€‰æ‹©å‘¨</label>
              <input type="week" id="meal-mgr-week" class="input" onchange="renderMgrMealsWeek()" />
            </div>
          </div>

          <div class="card" style="margin-top:16px; background:#eff6ff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-size:14px; color:#6b7280;">Tá»•ng tuáº§n / å‘¨åˆè®¡</div>
                <div id="week-date-range" style="font-size:13px; color:#2563eb;"></div>
              </div>
              <div style="text-align:right;">
                <div id="stat-week-total" style="font-size:28px; font-weight:bold; color:#2563eb;">0</div>
                <div style="font-size:12px; color:#6b7280;">suáº¥t cÆ¡m / ä»½é¤</div>
              </div>
            </div>
          </div>

          <div class="section-title">Chi tiáº¿t theo ngÃ y / æ¯æ—¥æ˜ç»†</div>
          <div id="mgr-meal-week-list"></div>
        </div>

        <!-- Month Report -->
        <div id="meal-report-month" style="display:none;">
          <div class="card">
            <div class="form-group" style="margin-bottom:0;">
              <label class="label">Chá»n thÃ¡ng / é€‰æ‹©æœˆä»½</label>
              <input type="month" id="meal-mgr-month" class="input" onchange="renderMgrMealsMonth()" />
            </div>
          </div>

          <div class="card" style="margin-top:16px; background:#eff6ff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-size:14px; color:#6b7280;">Tá»•ng thÃ¡ng / æœˆåˆè®¡</div>
                <div id="month-name" style="font-size:13px; color:#2563eb;"></div>
              </div>
              <div style="text-align:right;">
                <div id="stat-month-total" style="font-size:28px; font-weight:bold; color:#2563eb;">0</div>
                <div style="font-size:12px; color:#6b7280;">suáº¥t cÆ¡m / ä»½é¤</div>
              </div>
            </div>
          </div>

          <div class="section-title">Thá»‘ng kÃª theo nhÃ¢n viÃªn / å‘˜å·¥ç»Ÿè®¡</div>
          <div id="mgr-meal-month-list"></div>

          <div class="section-title">Chi tiáº¿t theo tuáº§n / æ¯å‘¨æ˜ç»†</div>
          <div id="mgr-meal-month-weeks"></div>
        </div>
      </div>
    </div>

    <!-- Manager Attendance -->
    <div id="page-mgr-attendance" class="page" style="padding:0;">
      <div class="header">
        <span>Cháº¥m cÃ´ng / è€ƒå‹¤</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card">
          <div class="form-group">
            <label class="label">Chá»n thÃ¡ng / é€‰æ‹©æœˆä»½</label>
            <input type="month" id="attendance-month" class="input" onchange="renderAttendance()" />
          </div>
        </div>
        <div id="mgr-attendance-list"></div>
      </div>
    </div>

    <!-- Manager Change Password -->
    <div id="page-mgr-password" class="page" style="padding:0;">
      <div class="header">
        <span>Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card">
          <div class="form-group">
            <label class="label">Máº­t kháº©u hiá»‡n táº¡i / å½“å‰å¯†ç </label>
            <input type="password" id="mgr-current-password" class="input" placeholder="Nháº­p máº­t kháº©u hiá»‡n táº¡i / è¯·è¾“å…¥å½“å‰å¯†ç " />
          </div>
          <div class="form-group">
            <label class="label">Máº­t kháº©u má»›i / æ–°å¯†ç </label>
            <input type="password" id="mgr-new-password" class="input" placeholder="Nháº­p máº­t kháº©u má»›i / è¯·è¾“å…¥æ–°å¯†ç " />
          </div>
          <div class="form-group">
            <label class="label">XÃ¡c nháº­n máº­t kháº©u má»›i / ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="mgr-confirm-password" class="input" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i / è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " />
          </div>
          <button class="btn btn-primary" onclick="changeMgrPassword()">Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </button>
        </div>
      </div>
    </div>

    <!-- ==================== KITCHEN PAGES ==================== -->

    <!-- Kitchen Home -->
    <div id="page-kitchen-home" class="page" style="padding:0;">
      <div class="header" style="background:#059669;">
        <span>ğŸ³ NhÃ  Báº¿p / å¨æˆ¿</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <!-- Today info - Main focus: sá»‘ suáº¥t cÆ¡m cáº§n náº¥u -->
        <div class="card" style="background:linear-gradient(135deg, #059669 0%, #047857 100%); color:white; margin-bottom:16px; text-align:center;">
          <div style="font-size:14px; opacity:0.9;">HÃ´m nay / ä»Šå¤© - <span id="kitchen-today-date"></span></div>
          <div style="font-size:72px; font-weight:bold; margin:20px 0;" id="kitchen-final-meals">0</div>
          <div style="font-size:20px;">SUáº¤T CÆ M / ä»½é¤</div>
          <div style="font-size:13px; opacity:0.8; margin-top:12px;" id="kitchen-calc-detail"></div>
        </div>

        <div class="menu-item" onclick="showKitchenPage('meals')">
          <span class="menu-icon">ğŸš</span>
          <span class="menu-text">Danh sÃ¡ch Äƒn cÆ¡m / ç”¨é¤åå•</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showKitchenPage('leaves')">
          <span class="menu-icon">ğŸ“…</span>
          <span class="menu-text">Danh sÃ¡ch nghá»‰ hÃ´m nay / ä»Šæ—¥è¯·å‡åå•</span>
          <span class="menu-arrow">â€º</span>
        </div>

        <div class="menu-item" onclick="showKitchenPage('password')">
          <span class="menu-icon">ğŸ”’</span>
          <span class="menu-text">Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </span>
          <span class="menu-arrow">â€º</span>
        </div>
      </div>
    </div>

    <!-- Kitchen Meals List -->
    <div id="page-kitchen-meals" class="page" style="padding:0;">
      <div class="header" style="background:#059669;">
        <span>Danh sÃ¡ch Äƒn cÆ¡m / ç”¨é¤åå•</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card" style="margin-bottom:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-size:14px; color:#6b7280;">HÃ´m nay / ä»Šå¤©</div>
              <div id="kitchen-meals-date" style="font-size:16px; font-weight:600;"></div>
            </div>
            <div style="text-align:right;">
              <div id="kitchen-meals-total" style="font-size:24px; font-weight:bold; color:#059669;">0</div>
              <div style="font-size:12px; color:#6b7280;">suáº¥t cÆ¡m / ä»½é¤</div>
            </div>
          </div>
        </div>

        <div class="section-title">Danh sÃ¡ch nhÃ¢n viÃªn Äƒn cÆ¡m / ç”¨é¤å‘˜å·¥åå•</div>
        <div id="kitchen-meal-list"></div>
      </div>
    </div>

    <!-- Kitchen Leaves List -->
    <div id="page-kitchen-leaves" class="page" style="padding:0;">
      <div class="header" style="background:#059669;">
        <span>Danh sÃ¡ch nghá»‰ hÃ´m nay / ä»Šæ—¥è¯·å‡åå•</span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card" style="margin-bottom:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-size:14px; color:#6b7280;">HÃ´m nay / ä»Šå¤©</div>
              <div id="kitchen-leaves-date" style="font-size:16px; font-weight:600;"></div>
            </div>
            <div style="text-align:right;">
              <div id="kitchen-leaves-total" style="font-size:24px; font-weight:bold; color:#ef4444;">0</div>
              <div style="font-size:12px; color:#6b7280;">ngÆ°á»i nghá»‰ / äººè¯·å‡</div>
            </div>
          </div>
        </div>

        <div class="section-title">Danh sÃ¡ch nghá»‰ phÃ©p / è¯·å‡åå•</div>
        <div id="kitchen-leave-list"></div>
      </div>
    </div>

    <!-- Kitchen Change Password -->
    <div id="page-kitchen-password" class="page" style="padding:0;">
      <div class="header" style="background:#059669;">
        <span>Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </span>
        <button class="header-logout" onclick="handleLogout()">ÄÄƒng xuáº¥t / é€€å‡º</button>
      </div>
      <div style="padding:20px;">
        <div class="card">
          <div class="form-group">
            <label class="label">Máº­t kháº©u hiá»‡n táº¡i / å½“å‰å¯†ç </label>
            <input type="password" id="kitchen-current-password" class="input" placeholder="Nháº­p máº­t kháº©u hiá»‡n táº¡i / è¯·è¾“å…¥å½“å‰å¯†ç " />
          </div>
          <div class="form-group">
            <label class="label">Máº­t kháº©u má»›i / æ–°å¯†ç </label>
            <input type="password" id="kitchen-new-password" class="input" placeholder="Nháº­p máº­t kháº©u má»›i / è¯·è¾“å…¥æ–°å¯†ç " />
          </div>
          <div class="form-group">
            <label class="label">XÃ¡c nháº­n máº­t kháº©u má»›i / ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="kitchen-confirm-password" class="input" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i / è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " />
          </div>
          <button class="btn btn-primary" onclick="changeKitchenPassword()">Äá»•i máº­t kháº©u / ä¿®æ”¹å¯†ç </button>
        </div>
      </div>
    </div>

    <!-- ==================== BOTTOM NAVIGATION ==================== -->

    <!-- Employee Nav -->
    <div id="emp-nav" class="bottom-nav" style="display:none;">
      <div class="nav-item active" onclick="showEmpPage('home')" id="emp-nav-home">
        <div class="nav-icon">ğŸ </div>
        <div>Trang chá»§ / é¦–é¡µ</div>
      </div>
      <div class="nav-item" onclick="showEmpPage('leave')" id="emp-nav-leave">
        <div class="nav-icon">ğŸ“…</div>
        <div>Nghá»‰ phÃ©p / è¯·å‡</div>
      </div>
      <div class="nav-item" onclick="showEmpPage('meal')" id="emp-nav-meal">
        <div class="nav-icon">ğŸš</div>
        <div>BÃ¡o cÆ¡m / è®¢é¤</div>
      </div>
      <div class="nav-item" onclick="showEmpPage('history')" id="emp-nav-history">
        <div class="nav-icon">ğŸ“‹</div>
        <div>Lá»‹ch sá»­ / è®°å½•</div>
      </div>
    </div>

    <!-- Manager Nav -->
    <div id="mgr-nav" class="bottom-nav" style="display:none;">
      <div class="nav-item active" onclick="showMgrPage('home')" id="mgr-nav-home">
        <div class="nav-icon">ğŸ </div>
        <div>Trang chá»§ / é¦–é¡µ</div>
      </div>
      <div class="nav-item" onclick="showMgrPage('leaves')" id="mgr-nav-leaves">
        <div class="nav-icon">ğŸ“‹</div>
        <div>Theo dÃµi / æŸ¥çœ‹</div>
      </div>
      <div class="nav-item" onclick="showMgrPage('meals')" id="mgr-nav-meals">
        <div class="nav-icon">ğŸš</div>
        <div>BÃ¡o cÆ¡m / è®¢é¤</div>
      </div>
      <div class="nav-item" onclick="showMgrPage('employees')" id="mgr-nav-employees">
        <div class="nav-icon">ğŸ‘¥</div>
        <div>NhÃ¢n viÃªn / å‘˜å·¥</div>
      </div>
    </div>

    <!-- Kitchen Nav -->
    <div id="kitchen-nav" class="bottom-nav" style="display:none;">
      <div class="nav-item active" onclick="showKitchenPage('home')" id="kitchen-nav-home">
        <div class="nav-icon">ğŸ </div>
        <div>Trang chá»§ / é¦–é¡µ</div>
      </div>
      <div class="nav-item" onclick="showKitchenPage('meals')" id="kitchen-nav-meals">
        <div class="nav-icon">ğŸš</div>
        <div>Ä‚n cÆ¡m / ç”¨é¤</div>
      </div>
      <div class="nav-item" onclick="showKitchenPage('leaves')" id="kitchen-nav-leaves">
        <div class="nav-icon">ğŸ“…</div>
        <div>Nghá»‰ phÃ©p / è¯·å‡</div>
      </div>
    </div>

  </div>

  <!-- ==================== MODALS ==================== -->

  <!-- Modal: Add Employee -->
  <div class="modal-overlay" id="modal-add-employee">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ThÃªm nhÃ¢n viÃªn / æ·»åŠ å‘˜å·¥</div>
        <button class="modal-close" onclick="closeModal('modal-add-employee')">&times;</button>
      </div>
      <div class="form-group">
        <label class="label">Há» vÃ  tÃªn / å§“å</label>
        <input type="text" id="emp-name" class="input" placeholder="Nguyá»…n VÄƒn A / å¼ ä¸‰" />
      </div>
      <div class="form-group">
        <label class="label">TÃªn Ä‘Äƒng nháº­p / ç”¨æˆ·å</label>
        <input type="text" id="emp-username" class="input" placeholder="nv2" />
      </div>
      <div class="form-group">
        <label class="label">Máº­t kháº©u / å¯†ç </label>
        <input type="password" id="emp-password" class="input" placeholder="123456" />
      </div>
      <div class="form-group">
        <label class="label">PhÃ²ng ban / éƒ¨é—¨</label>
        <input type="text" id="emp-department" class="input" placeholder="Ká»¹ thuáº­t / æŠ€æœ¯éƒ¨" />
      </div>
      <button class="btn btn-primary" onclick="saveEmployee()">LÆ°u nhÃ¢n viÃªn / ä¿å­˜</button>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast"></div>

  <!-- DEBUG LOG - nhá» gá»n, cÃ³ nÃºt áº©n -->
  <div id="debug-toggle" onclick="var d=document.getElementById('debug-log');d.style.display=d.style.display==='none'?'block':'none'" style="position:fixed;top:5px;right:5px;background:#e00;color:#fff;padding:3px 8px;font-size:10px;border-radius:3px;z-index:10000;">LOG</div>
  <div id="debug-log" style="position:fixed;bottom:70px;left:5px;right:5px;max-height:100px;overflow-y:auto;background:rgba(0,0,0,0.8);color:#0f0;font-size:9px;padding:5px;font-family:monospace;z-index:9999;border-radius:5px;"></div>

  <script>
    // DEBUG: Ghi log ra mÃ n hÃ¬nh
    const debugLog = document.getElementById('debug-log');
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      debugLog.innerHTML += `[${time}] ${msg}<br>`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(msg);
    }
    window.onerror = function(msg, url, line) {
      log(`âŒ ERROR: ${msg} at line ${line}`);
      return false;
    };
    log('ğŸš€ Script started');

    // ============ FIREBASE REST API CONFIG ============
    const FIREBASE_PROJECT_ID = 'leave-meal-management';
    const FIRESTORE_BASE_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents`;
    log('ğŸ“¡ Firestore URL: ' + FIRESTORE_BASE_URL);

    // ============ DATA & STATE ============
    let currentUser = null;
    let currentTime = 'full';
    let pendingLeave = null;
    let currentLeaveFilter = 'approved';
    let editingEmployeeId = null;

    // Local cache for data
    let cachedUsers = [];
    let cachedLeaves = [];
    let cachedMeals = {};

    // Default users
    const DEFAULT_USERS = [
      { id: 1, username: 'admin', password: '123456', name: 'Quáº£n lÃ½', role: 'manager', department: 'Quáº£n lÃ½' },
      { id: 2, username: 'nv1', password: '123456', name: 'Nguyá»…n VÄƒn A', role: 'employee', department: 'Ká»¹ thuáº­t' },
      { id: 3, username: 'nv2', password: '123456', name: 'Tráº§n Thá»‹ B', role: 'employee', department: 'Káº¿ toÃ¡n' },
      { id: 4, username: 'nhabep', password: '123456', name: 'NhÃ  Báº¿p', role: 'kitchen', department: 'NhÃ  báº¿p' }
    ];

    // ============ FIRESTORE REST API HELPERS ============

    // Convert JS object to Firestore document format
    function toFirestoreValue(value) {
      if (value === null || value === undefined) return { nullValue: null };
      if (typeof value === 'string') return { stringValue: value };
      if (typeof value === 'number') {
        if (Number.isInteger(value)) return { integerValue: value.toString() };
        return { doubleValue: value };
      }
      if (typeof value === 'boolean') return { booleanValue: value };
      if (Array.isArray(value)) return { arrayValue: { values: value.map(toFirestoreValue) } };
      if (typeof value === 'object') {
        const fields = {};
        for (const key in value) {
          fields[key] = toFirestoreValue(value[key]);
        }
        return { mapValue: { fields } };
      }
      return { stringValue: String(value) };
    }

    function toFirestoreDoc(obj) {
      const fields = {};
      for (const key in obj) {
        fields[key] = toFirestoreValue(obj[key]);
      }
      return { fields };
    }

    // Convert Firestore document to JS object
    function fromFirestoreValue(value) {
      if ('stringValue' in value) return value.stringValue;
      if ('integerValue' in value) return parseInt(value.integerValue);
      if ('doubleValue' in value) return value.doubleValue;
      if ('booleanValue' in value) return value.booleanValue;
      if ('nullValue' in value) return null;
      if ('arrayValue' in value) return (value.arrayValue.values || []).map(fromFirestoreValue);
      if ('mapValue' in value) return fromFirestoreDoc({ fields: value.mapValue.fields });
      return null;
    }

    function fromFirestoreDoc(doc) {
      if (!doc || !doc.fields) return null;
      const obj = {};
      for (const key in doc.fields) {
        obj[key] = fromFirestoreValue(doc.fields[key]);
      }
      return obj;
    }

    // REST API calls
    async function firestoreGet(collection) {
      try {
        const response = await fetch(`${FIRESTORE_BASE_URL}/${collection}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return (data.documents || []).map(doc => {
          const obj = fromFirestoreDoc(doc);
          obj._docId = doc.name.split('/').pop();
          return obj;
        });
      } catch (e) {
        console.error(`Error getting ${collection}:`, e);
        return [];
      }
    }

    async function firestoreSet(collection, docId, data) {
      try {
        const response = await fetch(`${FIRESTORE_BASE_URL}/${collection}/${docId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(toFirestoreDoc(data))
        });
        return response.ok;
      } catch (e) {
        console.error(`Error setting ${collection}/${docId}:`, e);
        return false;
      }
    }

    async function firestoreAdd(collection, data) {
      try {
        const response = await fetch(`${FIRESTORE_BASE_URL}/${collection}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(toFirestoreDoc(data))
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();
        return result.name.split('/').pop();
      } catch (e) {
        console.error(`Error adding to ${collection}:`, e);
        return null;
      }
    }

    async function firestoreDelete(collection, docId) {
      try {
        const response = await fetch(`${FIRESTORE_BASE_URL}/${collection}/${docId}`, {
          method: 'DELETE'
        });
        return response.ok;
      } catch (e) {
        console.error(`Error deleting ${collection}/${docId}:`, e);
        return false;
      }
    }

    async function firestoreUpdate(collection, docId, updates) {
      try {
        const updateMask = Object.keys(updates).map(k => `updateMask.fieldPaths=${k}`).join('&');
        const response = await fetch(`${FIRESTORE_BASE_URL}/${collection}/${docId}?${updateMask}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(toFirestoreDoc(updates))
        });
        return response.ok;
      } catch (e) {
        console.error(`Error updating ${collection}/${docId}:`, e);
        return false;
      }
    }

    // ============ STORAGE HELPERS ============

    // Initialize default data
    async function initFirebaseData() {
      try {
        const users = await firestoreGet('users');
        if (users.length === 0) {
          for (const user of DEFAULT_USERS) {
            await firestoreSet('users', user.id.toString(), user);
          }
          console.log('Default users added to Firestore');
        }
      } catch (e) {
        console.error('Error initializing Firebase data:', e);
      }
    }

    // USERS
    function getUsers() {
      return cachedUsers.length > 0 ? cachedUsers : DEFAULT_USERS;
    }

    async function loadUsersFromFirebase() {
      try {
        const users = await firestoreGet('users');
        cachedUsers = users.length > 0 ? users : DEFAULT_USERS;
        // Ensure kitchen user exists
        const hasKitchen = cachedUsers.find(u => u.role === 'kitchen');
        if (!hasKitchen) {
          const kitchenUser = { id: 4, username: 'nhabep', password: '123456', name: 'NhÃ  Báº¿p', role: 'kitchen', department: 'NhÃ  báº¿p' };
          cachedUsers.push(kitchenUser);
          await firestoreSet('users', '4', kitchenUser);
        }
        return cachedUsers;
      } catch (e) {
        console.error('Error loading users:', e);
        cachedUsers = DEFAULT_USERS;
        return DEFAULT_USERS;
      }
    }

    async function saveUser(user) {
      await firestoreSet('users', user.id.toString(), user);
      const idx = cachedUsers.findIndex(u => u.id === user.id);
      if (idx !== -1) {
        cachedUsers[idx] = user;
      } else {
        cachedUsers.push(user);
      }
    }

    async function deleteUserFromFirebase(userId) {
      await firestoreDelete('users', userId.toString());
      cachedUsers = cachedUsers.filter(u => u.id !== userId);
    }

    // LEAVES
    function getLeaves() {
      return cachedLeaves;
    }

    async function loadLeavesFromFirebase() {
      try {
        cachedLeaves = await firestoreGet('leaves');
        cachedLeaves.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
        return cachedLeaves;
      } catch (e) {
        console.error('Error loading leaves:', e);
        return [];
      }
    }

    async function addLeave(leave) {
      const docId = await firestoreAdd('leaves', leave);
      if (docId) {
        leave._docId = docId;
        cachedLeaves.unshift(leave);
        return leave;
      }
      return null;
    }

    async function updateLeave(leaveId, updates) {
      const leave = cachedLeaves.find(l => l.id === leaveId);
      if (leave && leave._docId) {
        await firestoreUpdate('leaves', leave._docId, updates);
        Object.assign(leave, updates);
      }
    }

    // MEALS
    function getMeals() {
      return cachedMeals;
    }

    async function loadMealsFromFirebase() {
      try {
        const meals = await firestoreGet('meals');
        cachedMeals = {};
        meals.forEach(m => {
          cachedMeals[m._docId] = m;
        });
        return cachedMeals;
      } catch (e) {
        console.error('Error loading meals:', e);
        return {};
      }
    }

    async function saveMeal(date, meal) {
      const mealKey = `${meal.userId}_${date}`;
      await firestoreSet('meals', mealKey, { ...meal, date });
      cachedMeals[mealKey] = { ...meal, date };
    }

    // Polling for sync (thay tháº¿ realtime listeners)
    let syncInterval = null;
    function startDataSync() {
      // Sync data every 30 seconds
      syncInterval = setInterval(async () => {
        if (currentUser) {
          await loadUsersFromFirebase();
          await loadLeavesFromFirebase();
          await loadMealsFromFirebase();
          console.log('Data synced at', new Date().toLocaleTimeString());
        }
      }, 30000);
    }

    function stopDataSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
    }

    // ============ AUTH ============
    function handleLogin() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');

      if (!username || !password) {
        errorDiv.textContent = 'Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin / è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        errorDiv.classList.add('show');
        return;
      }

      const users = getUsers();
      const user = users.find(u => u.username === username && u.password === password);

      if (!user) {
        errorDiv.textContent = 'TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng / ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        errorDiv.classList.add('show');
        return;
      }

      currentUser = user;
      localStorage.setItem('currentUser', JSON.stringify(user));
      errorDiv.classList.remove('show');
      showApp();
    }

    function handleLogout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      stopInactivityTimer();
      document.getElementById('app-container').style.display = 'none';
      document.getElementById('login-page').classList.add('active');
      document.getElementById('emp-nav').style.display = 'none';
      document.getElementById('mgr-nav').style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
    }

    // ===== AUTO LOGOUT SAU 5 PHÃšT KHÃ”NG HOáº T Äá»˜NG / 5åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨é€€å‡º =====
    let inactivityTimer = null;
    const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 phÃºt = 300000ms

    function resetInactivityTimer() {
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
      }
      if (currentUser) {
        inactivityTimer = setTimeout(() => {
          showToast('PhiÃªn Ä‘Äƒng nháº­p háº¿t háº¡n do khÃ´ng hoáº¡t Ä‘á»™ng / ç™»å½•ä¼šè¯å› æ— æ“ä½œå·²è¿‡æœŸ');
          setTimeout(() => {
            handleLogout();
          }, 1500);
        }, INACTIVITY_TIMEOUT);
      }
    }

    function stopInactivityTimer() {
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
        inactivityTimer = null;
      }
    }

    function startInactivityTimer() {
      // Láº¯ng nghe cÃ¡c sá»± kiá»‡n tÆ°Æ¡ng tÃ¡c ngÆ°á»i dÃ¹ng
      const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
      events.forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
      });
      resetInactivityTimer();
    }

    function showApp() {
      document.getElementById('login-page').classList.remove('active');
      document.getElementById('app-container').style.display = 'block';

      // Báº¯t Ä‘áº§u Ä‘áº¿m thá»i gian khÃ´ng hoáº¡t Ä‘á»™ng / å¼€å§‹è®¡ç®—æ— æ“ä½œæ—¶é—´
      startInactivityTimer();

      // Hide all navs first
      document.getElementById('emp-nav').style.display = 'none';
      document.getElementById('mgr-nav').style.display = 'none';
      document.getElementById('kitchen-nav').style.display = 'none';

      if (currentUser.role === 'manager') {
        document.getElementById('mgr-nav').style.display = 'flex';
        showMgrPage('home');
      } else if (currentUser.role === 'kitchen') {
        document.getElementById('kitchen-nav').style.display = 'flex';
        showKitchenPage('home');
      } else {
        document.getElementById('emp-nav').style.display = 'flex';
        showEmpPage('home');
      }
    }

    async function changePassword() {
      const current = document.getElementById('current-password').value;
      const newPwd = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;

      if (!current || !newPwd || !confirm) {
        showToast('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin / è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      if (current !== currentUser.password) {
        showToast('Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng / å½“å‰å¯†ç é”™è¯¯');
        return;
      }

      if (newPwd !== confirm) {
        showToast('Máº­t kháº©u má»›i khÃ´ng khá»›p / æ–°å¯†ç ä¸åŒ¹é…');
        return;
      }

      if (newPwd.length < 6) {
        showToast('Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»± / æ–°å¯†ç è‡³å°‘6ä½');
        return;
      }

      currentUser.password = newPwd;
      await saveUser(currentUser);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));

      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
      showToast('Äá»•i máº­t kháº©u thÃ nh cÃ´ng! / ä¿®æ”¹å¯†ç æˆåŠŸ!');
    }

    // Manager change password
    async function changeMgrPassword() {
      const current = document.getElementById('mgr-current-password').value;
      const newPwd = document.getElementById('mgr-new-password').value;
      const confirm = document.getElementById('mgr-confirm-password').value;

      if (!current || !newPwd || !confirm) {
        showToast('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin / è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }
      if (current !== currentUser.password) {
        showToast('Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng / å½“å‰å¯†ç é”™è¯¯');
        return;
      }
      if (newPwd !== confirm) {
        showToast('Máº­t kháº©u má»›i khÃ´ng khá»›p / æ–°å¯†ç ä¸åŒ¹é…');
        return;
      }
      if (newPwd.length < 6) {
        showToast('Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»± / æ–°å¯†ç è‡³å°‘6ä½');
        return;
      }

      currentUser.password = newPwd;
      await saveUser(currentUser);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));

      document.getElementById('mgr-current-password').value = '';
      document.getElementById('mgr-new-password').value = '';
      document.getElementById('mgr-confirm-password').value = '';
      showToast('Äá»•i máº­t kháº©u thÃ nh cÃ´ng! / ä¿®æ”¹å¯†ç æˆåŠŸ!');
    }

    // Kitchen change password
    async function changeKitchenPassword() {
      const current = document.getElementById('kitchen-current-password').value;
      const newPwd = document.getElementById('kitchen-new-password').value;
      const confirm = document.getElementById('kitchen-confirm-password').value;

      if (!current || !newPwd || !confirm) {
        showToast('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin / è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }
      if (current !== currentUser.password) {
        showToast('Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng / å½“å‰å¯†ç é”™è¯¯');
        return;
      }
      if (newPwd !== confirm) {
        showToast('Máº­t kháº©u má»›i khÃ´ng khá»›p / æ–°å¯†ç ä¸åŒ¹é…');
        return;
      }
      if (newPwd.length < 6) {
        showToast('Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»± / æ–°å¯†ç è‡³å°‘6ä½');
        return;
      }

      currentUser.password = newPwd;
      await saveUser(currentUser);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));

      document.getElementById('kitchen-current-password').value = '';
      document.getElementById('kitchen-new-password').value = '';
      document.getElementById('kitchen-confirm-password').value = '';
      showToast('Äá»•i máº­t kháº©u thÃ nh cÃ´ng! / ä¿®æ”¹å¯†ç æˆåŠŸ!');
    }

    // ============ NAVIGATION ============
    function showEmpPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('#emp-nav .nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById('page-emp-' + page).classList.add('active');
      const navItem = document.getElementById('emp-nav-' + page);
      if (navItem) navItem.classList.add('active');

      if (page === 'home') renderEmpHome();
      if (page === 'leave') {
        // Set default date to tomorrow (not today - to avoid late warning)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('leave-date').value = tomorrow.toISOString().split('T')[0];
        isCurrentLeaveLate = false;
        updateMealOptions();
      }
      if (page === 'meal') renderMealPage();
      if (page === 'history') renderEmpLeaveHistory();
    }

    function showMgrPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('#mgr-nav .nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById('page-mgr-' + page).classList.add('active');
      const navItem = document.getElementById('mgr-nav-' + page);
      if (navItem) navItem.classList.add('active');

      if (page === 'home') renderMgrHome();
      if (page === 'leaves') renderMgrLeaves();
      if (page === 'employees') renderMgrEmployees();
      if (page === 'meals') {
        document.getElementById('meal-mgr-date').value = getToday();
        renderMgrMeals();
      }
      if (page === 'attendance') {
        document.getElementById('attendance-month').value = getCurrentMonth();
        renderAttendance();
      }
    }

    // ============ UTILITIES ============
    function getToday() {
      return new Date().toISOString().split('T')[0];
    }

    function getCurrentMonth() {
      return new Date().toISOString().slice(0, 7);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('vi-VN');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ============ EMPLOYEE HOME ============
    function renderEmpHome() {
      document.getElementById('emp-header-name').textContent = 'Xin chÃ o, ' + currentUser.name;

      // Get today's meal status
      const today = getToday();
      const meals = getMeals();
      const mealCard = document.getElementById('emp-meal-card');
      const mealStatus = document.getElementById('emp-meal-status');
      const mealIcon = document.getElementById('emp-meal-icon');

      // Find meal for current user today
      const empMealKeys = Object.keys(meals).filter(k => {
        const m = meals[k];
        return m.date === today && m.userId === currentUser.id;
      });

      if (empMealKeys.length > 0) {
        const meal = meals[empMealKeys[0]];
        if (meal.registered === false) {
          // User cancelled or auto-cancelled by leave
          mealStatus.textContent = meal.cancelledByLeave ? 'Cáº¯t cÆ¡m (nghá»‰ phÃ©p)' : 'ÄÃ£ há»§y cÆ¡m';
          mealStatus.style.color = '#ef4444';
          mealIcon.textContent = 'âŒ';
          mealCard.style.borderLeft = '4px solid #ef4444';
        } else {
          // Explicitly registered
          mealStatus.textContent = 'CÃ³ cÆ¡m';
          mealStatus.style.color = '#10b981';
          mealIcon.textContent = 'âœ…';
          mealCard.style.borderLeft = '4px solid #10b981';
        }
      } else {
        // No record = default cÃ³ cÆ¡m (Ä‘i lÃ m bÃ¬nh thÆ°á»ng)
        mealStatus.textContent = 'CÃ³ cÆ¡m (máº·c Ä‘á»‹nh)';
        mealStatus.style.color = '#10b981';
        mealIcon.textContent = 'âœ…';
        mealCard.style.borderLeft = '4px solid #10b981';
      }
    }

    // ============ LEAVE REQUEST ============
    let wantCancelMeal = false; // Track meal cancel choice for half-day leave
    let isCurrentLeaveLate = false; // Track if current leave date is late

    // Check if leave date is late (same day or past)
    function isLateLeaveRequest(leaveDate) {
      const today = new Date();
      const leave = new Date(leaveDate);

      // Reset time to compare dates only
      today.setHours(0, 0, 0, 0);
      leave.setHours(0, 0, 0, 0);

      // If leave date is today or in the past = late
      return leave <= today;
    }

    // Called when user changes leave date
    function checkLeaveDate() {
      const date = document.getElementById('leave-date').value;
      if (!date) return;

      isCurrentLeaveLate = isLateLeaveRequest(date);
      updateMealOptions();
    }

    // Update meal cancel options based on time and late status
    function updateMealOptions() {
      const lateWarning = document.getElementById('late-leave-warning');
      const mealCancelOption = document.getElementById('meal-cancel-option');
      const mealAutoNotice = document.getElementById('meal-auto-cancel-notice');

      if (isCurrentLeaveLate) {
        // Late leave - show warning, hide meal options
        lateWarning.style.display = 'block';
        mealCancelOption.style.display = 'none';
        mealAutoNotice.style.display = 'none';
        wantCancelMeal = false; // Can't cancel meal when late
      } else {
        // Normal leave - hide warning, show appropriate meal option
        lateWarning.style.display = 'none';

        if (currentTime === 'full') {
          mealCancelOption.style.display = 'none';
          mealAutoNotice.style.display = 'block';
          wantCancelMeal = true;
        } else {
          mealCancelOption.style.display = 'block';
          mealAutoNotice.style.display = 'none';
          // Keep current wantCancelMeal value for half day
        }
      }
    }

    function selectTime(time, btn) {
      currentTime = time;
      // Update time buttons
      document.querySelectorAll('#page-emp-leave .time-options').forEach((group, idx) => {
        if (idx === 0) { // Only first time-options group (time selection)
          group.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        }
      });
      btn.classList.add('active');

      // Reset meal cancel choice for half day
      if (time !== 'full') {
        wantCancelMeal = false;
        document.getElementById('btn-cancel-meal-yes').classList.remove('active');
        document.getElementById('btn-cancel-meal-no').classList.add('active');
      }

      updateMealOptions();
    }

    function selectMealCancel(cancel, btn) {
      wantCancelMeal = cancel;
      document.getElementById('btn-cancel-meal-yes').classList.toggle('active', cancel);
      document.getElementById('btn-cancel-meal-no').classList.toggle('active', !cancel);
    }

    async function submitLeave() {
      const date = document.getElementById('leave-date').value;
      const reason = document.getElementById('leave-reason').value;

      if (!date) {
        showToast('Vui lÃ²ng chá»n ngÃ y nghá»‰ / è¯·é€‰æ‹©è¯·å‡æ—¥æœŸ');
        return;
      }

      // Check if late leave request
      const isLate = isLateLeaveRequest(date);
      let canCancelMeal = wantCancelMeal && !isLate;

      const leave = {
        id: Date.now(),
        userId: currentUser.id,
        userName: currentUser.name,
        date: date,
        timePeriod: currentTime,
        reason: reason,
        status: 'approved',
        mealCancelled: canCancelMeal,
        isLate: isLate,
        createdAt: new Date().toISOString()
      };

      // Handle meal cancellation - only if not late
      if (canCancelMeal) {
        let cancelReason = '';
        if (currentTime === 'full') {
          cancelReason = 'Nghá»‰ phÃ©p cáº£ ngÃ y';
        } else if (currentTime === 'morning') {
          cancelReason = 'Nghá»‰ buá»•i sÃ¡ng';
        } else {
          cancelReason = 'Nghá»‰ buá»•i chiá»u';
        }
        // Save meal cancellation to Firebase
        await saveMeal(date, {
          date,
          registered: false,
          cancelReason: cancelReason,
          cancelledByLeave: true,
          userId: currentUser.id
        });
      }

      // Save leave to Firebase
      await addLeave(leave);

      // Show appropriate message
      if (isLate) {
        showToast('âš ï¸ BÃ¡o nghá»‰ Ä‘á»™t xuáº¥t - KHÃ”NG Ká»ŠP cáº¯t cÆ¡m! / ä¸´æ—¶è¯·å‡-æ¥ä¸åŠå–æ¶ˆè®¢é¤!');
      } else if (canCancelMeal) {
        showToast('ÄÃ£ gá»­i Ä‘Æ¡n nghá»‰ phÃ©p vÃ  cáº¯t cÆ¡m! / å·²æäº¤è¯·å‡å¹¶å–æ¶ˆè®¢é¤!');
      } else {
        showToast('ÄÃ£ gá»­i Ä‘Æ¡n nghá»‰ phÃ©p! / å·²æäº¤è¯·å‡ç”³è¯·!');
      }

      resetLeaveForm();
    }

    function resetLeaveForm() {
      // Set default date to tomorrow (not today - to avoid late warning)
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('leave-date').value = tomorrow.toISOString().split('T')[0];

      document.getElementById('leave-reason').value = '';
      currentTime = 'full';
      wantCancelMeal = true;
      isCurrentLeaveLate = false;

      // Reset time buttons - select first one (full day)
      const timeButtons = document.querySelectorAll('#page-emp-leave .time-options')[0].querySelectorAll('.time-btn');
      timeButtons.forEach((b, i) => b.classList.toggle('active', i === 0));

      // Reset late warning
      document.getElementById('late-leave-warning').style.display = 'none';

      // Reset meal options visibility
      document.getElementById('meal-cancel-option').style.display = 'none';
      document.getElementById('meal-auto-cancel-notice').style.display = 'block';

      // Reset meal cancel buttons
      document.getElementById('btn-cancel-meal-yes').classList.remove('active');
      document.getElementById('btn-cancel-meal-no').classList.add('active');
    }

    function renderEmpLeaveHistory() {
      const leaves = getLeaves().filter(l => l.userId === currentUser.id);
      const container = document.getElementById('emp-leave-history');

      if (leaves.length === 0) {
        container.innerHTML = '<div class="empty">ChÆ°a cÃ³ Ä‘Æ¡n nghá»‰ phÃ©p nÃ o</div>';
        return;
      }

      container.innerHTML = leaves.map(l => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${formatDate(l.date)}</span>
            <span class="badge badge-${l.status}">${l.status === 'pending' ? 'Chá» duyá»‡t' : l.status === 'approved' ? 'ÄÃ£ duyá»‡t' : 'Tá»« chá»‘i'}</span>
          </div>
          <div class="list-item-subtitle">${l.timePeriod === 'full' ? 'Cáº£ ngÃ y' : l.timePeriod === 'morning' ? 'Buá»•i sÃ¡ng' : 'Buá»•i chiá»u'}</div>
          ${l.reason ? '<div class="text-small">' + l.reason + '</div>' : ''}
          ${l.mealCancelled ? '<div class="text-small text-orange">ğŸš ÄÃ£ cáº¯t cÆ¡m</div>' : ''}
        </div>
      `).join('');
    }

    // ============ MEAL ============
    // Logic: Äi lÃ m = máº·c Ä‘á»‹nh cÃ³ cÆ¡m. Chá»‰ cáº§n bÃ¡o khi Há»¦Y cÆ¡m.
    function renderMealPage() {
      const today = getToday();
      document.getElementById('today-date').textContent = formatDate(today);

      const meals = getMeals();
      const statusDiv = document.getElementById('meal-status');
      const cancelSection = document.getElementById('cancel-meal-section');
      const reregisterSection = document.getElementById('reregister-meal-section');

      // Find meal record for current user today
      const empMealKeys = Object.keys(meals).filter(k => {
        const m = meals[k];
        return m.date === today && m.userId === currentUser.id;
      });

      if (empMealKeys.length > 0) {
        const meal = meals[empMealKeys[0]];
        if (meal.cancelledByLeave) {
          // Cancelled due to leave - can't change
          statusDiv.innerHTML = '<div class="status-card status-warning">âš ï¸ ÄÃ£ tá»± Ä‘á»™ng cáº¯t cÆ¡m do nghá»‰ phÃ©p<br><small>' + meal.cancelReason + '</small></div>';
          cancelSection.style.display = 'none';
          reregisterSection.style.display = 'none';
        } else if (meal.registered === false) {
          // User cancelled meal - show re-register option
          statusDiv.innerHTML = '<div class="status-card status-error">âŒ Báº¡n ÄÃƒ Há»¦Y cÆ¡m hÃ´m nay' + (meal.cancelReason ? '<br><small>LÃ½ do: ' + meal.cancelReason + '</small>' : '') + '</div>';
          cancelSection.style.display = 'none';
          reregisterSection.style.display = 'block';
        } else {
          // Explicitly registered (after cancelling)
          statusDiv.innerHTML = '<div class="status-card status-success">âœ… Báº¡n CÃ“ CÆ M hÃ´m nay</div>';
          cancelSection.style.display = 'block';
          reregisterSection.style.display = 'none';
        }
      } else {
        // No record = default: cÃ³ cÆ¡m (Ä‘i lÃ m bÃ¬nh thÆ°á»ng)
        statusDiv.innerHTML = '<div class="status-card status-success">âœ… Báº¡n CÃ“ CÆ M hÃ´m nay <small>(máº·c Ä‘á»‹nh)</small></div>';
        cancelSection.style.display = 'block';
        reregisterSection.style.display = 'none';
      }
    }

    async function cancelMeal() {
      const reason = document.getElementById('cancel-reason').value;
      if (!reason.trim()) {
        showToast('Vui lÃ²ng nháº­p lÃ½ do há»§y / è¯·è¾“å…¥å–æ¶ˆåŸå› ');
        return;
      }
      const today = getToday();
      await saveMeal(today, { date: today, registered: false, cancelReason: reason, userId: currentUser.id });
      document.getElementById('cancel-reason').value = '';
      showToast('ÄÃ£ há»§y cÆ¡m hÃ´m nay! / å·²å–æ¶ˆä»Šæ—¥è®¢é¤!');
      renderMealPage();
      renderEmpHome();
    }

    async function reregisterMeal() {
      const today = getToday();
      await saveMeal(today, { date: today, registered: true, userId: currentUser.id });
      showToast('ÄÃ£ Ä‘Äƒng kÃ½ láº¡i cÆ¡m! / å·²é‡æ–°è®¢é¤!');
      renderMealPage();
      renderEmpHome();
    }

    // ============ MANAGER HOME ============
    function renderMgrHome() {
      document.getElementById('mgr-header-name').textContent = 'Xin chÃ o, ' + currentUser.name;

      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const leaves = getLeaves();
      const meals = getMeals();
      const today = getToday();

      const approvedLeaves = leaves.filter(l => l.status === 'approved');
      const todayLeaves = leaves.filter(l => l.date === today && l.status === 'approved');

      // Count meals: máº·c Ä‘á»‹nh cÃ³ cÆ¡m, chá»‰ trá»« nhá»¯ng ai Ä‘Ã£ há»§y
      const cancelledMeals = Object.values(meals).filter(m => m.date === today && m.registered === false);
      const todayMealCount = employees.length - cancelledMeals.length;

      document.getElementById('stat-employees').textContent = employees.length;
      document.getElementById('stat-pending').textContent = approvedLeaves.length;
      document.getElementById('stat-today-leave').textContent = todayLeaves.length;
      document.getElementById('stat-today-meal').textContent = todayMealCount;
    }

    // ============ MANAGER LEAVES ============
    function filterLeaves(status, tab) {
      currentLeaveFilter = status;
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderMgrLeaves();
    }

    function renderMgrLeaves() {
      const leaves = getLeaves().filter(l => l.status === currentLeaveFilter);
      const container = document.getElementById('mgr-leave-list');

      if (leaves.length === 0) {
        container.innerHTML = '<div class="empty">KhÃ´ng cÃ³ Ä‘Æ¡n nÃ o / æ²¡æœ‰è®°å½•</div>';
        return;
      }

      container.innerHTML = leaves.map(l => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${l.userName}</span>
            <span class="badge badge-${l.status}">${l.status === 'approved' ? 'ÄÃ£ duyá»‡t / å·²æ‰¹å‡†' : 'ÄÃ£ tá»« chá»‘i / å·²æ‹’ç»'}</span>
          </div>
          <div class="list-item-subtitle">${formatDate(l.date)} - ${l.timePeriod === 'full' ? 'Cáº£ ngÃ y / å…¨å¤©' : l.timePeriod === 'morning' ? 'Buá»•i sÃ¡ng / ä¸Šåˆ' : 'Buá»•i chiá»u / ä¸‹åˆ'}</div>
          ${l.reason ? '<div class="text-small">' + l.reason + '</div>' : ''}
          ${l.status === 'approved' ? `
            <div class="btn-row">
              <button class="btn btn-danger btn-sm" onclick="rejectLeave(${l.id})">âœ— Tá»« chá»‘i / æ‹’ç»</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async function rejectLeave(id) {
      if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n tá»« chá»‘i Ä‘Æ¡n nÃ y? / ç¡®å®šè¦æ‹’ç»æ­¤ç”³è¯·å—?')) return;
      await updateLeave(id, { status: 'rejected' });
      showToast('ÄÃ£ tá»« chá»‘i Ä‘Æ¡n nghá»‰ phÃ©p / å·²æ‹’ç»è¯·å‡ç”³è¯·');
      renderMgrLeaves();
      renderMgrHome();
    }

    // Switch between Approval and Report tabs
    function switchLeaveMainTab(tab, btn) {
      document.querySelectorAll('#page-mgr-leaves > div > .tabs:first-child .tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      document.getElementById('leave-approval-section').style.display = tab === 'approval' ? 'block' : 'none';
      document.getElementById('leave-report-section').style.display = tab === 'report' ? 'block' : 'none';

      if (tab === 'report') {
        populateLeaveEmployeeDropdown();
        document.getElementById('leave-report-date').value = getToday();
        renderLeaveReportDay();
      }
    }

    // Populate employee dropdown for leave reports
    function populateLeaveEmployeeDropdown() {
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const select = document.getElementById('leave-report-employee');
      const currentValue = select.value;

      select.innerHTML = '<option value="all">-- Táº¥t cáº£ nhÃ¢n viÃªn --</option>';
      employees.forEach(emp => {
        select.innerHTML += `<option value="${emp.id}">${emp.name} - ${emp.department || 'N/A'}</option>`;
      });

      // Restore previous selection if still valid
      if (currentValue && (currentValue === 'all' || employees.find(e => e.id == currentValue))) {
        select.value = currentValue;
      }
    }

    // Handle employee filter change
    function onLeaveEmployeeFilterChange() {
      // Re-render current active report tab
      const dayTab = document.getElementById('leave-report-day');
      const weekTab = document.getElementById('leave-report-week');
      const monthTab = document.getElementById('leave-report-month');

      if (dayTab.style.display !== 'none') {
        renderLeaveReportDay();
      } else if (weekTab.style.display !== 'none') {
        renderLeaveReportWeek();
      } else if (monthTab.style.display !== 'none') {
        renderLeaveReportMonth();
      }
    }

    // Get selected employee filter value
    function getLeaveEmployeeFilter() {
      const select = document.getElementById('leave-report-employee');
      return select ? select.value : 'all';
    }

    // Switch leave report tabs (day/week/month)
    function switchLeaveReportTab(tab, btn) {
      document.querySelectorAll('#leave-report-section > .tabs .tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      document.getElementById('leave-report-day').style.display = tab === 'day' ? 'block' : 'none';
      document.getElementById('leave-report-week').style.display = tab === 'week' ? 'block' : 'none';
      document.getElementById('leave-report-month').style.display = tab === 'month' ? 'block' : 'none';

      if (tab === 'day') {
        document.getElementById('leave-report-date').value = getToday();
        renderLeaveReportDay();
      } else if (tab === 'week') {
        const now = new Date();
        const year = now.getFullYear();
        const week = getWeekNumber(now);
        document.getElementById('leave-report-week-input').value = `${year}-W${week.toString().padStart(2, '0')}`;
        renderLeaveReportWeek();
      } else if (tab === 'month') {
        document.getElementById('leave-report-month-input').value = getCurrentMonth();
        renderLeaveReportMonth();
      }
    }

    // Render leave report by day
    function renderLeaveReportDay() {
      const date = document.getElementById('leave-report-date').value;
      if (!date) return;

      const empFilter = getLeaveEmployeeFilter();
      let leaves = getLeaves().filter(l => l.date === date && l.status === 'approved');
      if (empFilter !== 'all') {
        leaves = leaves.filter(l => l.userId == empFilter);
      }
      const container = document.getElementById('leave-day-list');

      const fullDay = leaves.filter(l => l.timePeriod === 'full').length;
      const halfDay = leaves.filter(l => l.timePeriod !== 'full').length;

      document.getElementById('stat-leave-day-total').textContent = leaves.length;
      document.getElementById('stat-leave-day-full').textContent = fullDay;

      if (leaves.length === 0) {
        container.innerHTML = '<div class="empty">KhÃ´ng cÃ³ ai nghá»‰ ngÃ y nÃ y</div>';
        return;
      }

      container.innerHTML = leaves.map(l => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${l.userName}</span>
            <span class="badge badge-rejected">${l.timePeriod === 'full' ? 'Cáº£ ngÃ y' : l.timePeriod === 'morning' ? 'SÃ¡ng' : 'Chiá»u'}</span>
          </div>
          ${l.reason ? '<div class="text-small">' + l.reason + '</div>' : ''}
        </div>
      `).join('');
    }

    // Render leave report by week
    function renderLeaveReportWeek() {
      const weekStr = document.getElementById('leave-report-week-input').value;
      if (!weekStr) return;

      const dates = getWeekDates(weekStr);
      const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
      const container = document.getElementById('leave-week-list');
      const empFilter = getLeaveEmployeeFilter();
      let leaves = getLeaves().filter(l => l.status === 'approved');
      if (empFilter !== 'all') {
        leaves = leaves.filter(l => l.userId == empFilter);
      }

      let totalDays = 0;
      const dailyData = [];
      dates.forEach(date => {
        const d = new Date(date);
        if (d.getDay() === 0) return; // Skip Sunday
        const dayName = dayNames[d.getDay()];
        const dayLeaves = leaves.filter(l => l.date === date);
        let days = 0;
        dayLeaves.forEach(l => {
          days += l.timePeriod === 'full' ? 1 : 0.5;
        });
        totalDays += days;
        dailyData.push({ date, dayName, count: dayLeaves.length, days });
      });

      document.getElementById('stat-leave-week-total').textContent = totalDays;
      // Show Mon-Sat range
      const monDate = dates.find(d => new Date(d).getDay() === 1);
      const satDate = dates.find(d => new Date(d).getDay() === 6);
      document.getElementById('leave-week-date-range').textContent = `${formatDate(monDate)} - ${formatDate(satDate)}`;

      container.innerHTML = dailyData.map(d => `
        <div class="list-item">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="list-item-title">${d.dayName}, ${formatDate(d.date)}</div>
              <div class="list-item-subtitle">${d.count} ngÆ°á»i nghá»‰</div>
            </div>
            <div style="text-align:right;">
              <span style="font-size:18px; font-weight:bold; color:#b45309;">${d.days}</span>
              <span style="font-size:12px; color:#92400e;"> ngÃ y</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Render leave report by month
    function renderLeaveReportMonth() {
      const monthStr = document.getElementById('leave-report-month-input').value;
      if (!monthStr) return;

      const [year, month] = monthStr.split('-');
      const users = getUsers();
      const empFilter = getLeaveEmployeeFilter();
      let employees = users.filter(u => u.role === 'employee');
      if (empFilter !== 'all') {
        employees = employees.filter(e => e.id == empFilter);
      }
      let leaves = getLeaves().filter(l => l.date.startsWith(monthStr) && l.status === 'approved');
      if (empFilter !== 'all') {
        leaves = leaves.filter(l => l.userId == empFilter);
      }
      const empContainer = document.getElementById('leave-month-emp-list');
      const weeksContainer = document.getElementById('leave-month-weeks');

      // Calculate total days
      let totalDays = 0;
      const empStats = {};
      employees.forEach(emp => {
        empStats[emp.id] = { name: emp.name, department: emp.department, days: 0 };
      });

      leaves.forEach(l => {
        const days = l.timePeriod === 'full' ? 1 : 0.5;
        totalDays += days;
        if (empStats[l.userId]) {
          empStats[l.userId].days += days;
        }
      });

      const monthNames = ['', 'ThÃ¡ng 1', 'ThÃ¡ng 2', 'ThÃ¡ng 3', 'ThÃ¡ng 4', 'ThÃ¡ng 5', 'ThÃ¡ng 6',
                          'ThÃ¡ng 7', 'ThÃ¡ng 8', 'ThÃ¡ng 9', 'ThÃ¡ng 10', 'ThÃ¡ng 11', 'ThÃ¡ng 12'];
      document.getElementById('stat-leave-month-total').textContent = totalDays;
      document.getElementById('leave-month-name').textContent = `${monthNames[parseInt(month)]}/${year}`;

      // Render employee stats (sorted by days desc)
      const empList = Object.values(empStats).filter(e => e.days > 0).sort((a, b) => b.days - a.days);
      if (empList.length === 0) {
        empContainer.innerHTML = '<div class="empty">KhÃ´ng cÃ³ nhÃ¢n viÃªn nÃ o nghá»‰</div>';
      } else {
        empContainer.innerHTML = empList.map(e => `
          <div class="list-item">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div class="list-item-title">${e.name}</div>
                <div class="list-item-subtitle">${e.department || 'N/A'}</div>
              </div>
              <div style="text-align:right;">
                <span style="font-size:18px; font-weight:bold; color:#b45309;">${e.days}</span>
                <span style="font-size:12px; color:#92400e;"> ngÃ y</span>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Render weekly breakdown
      const daysInMonth = new Date(year, month, 0).getDate();
      const weeks = [];
      let weekStart = 1;
      for (let i = 1; i <= daysInMonth; i++) {
        const d = new Date(year, month - 1, i);
        if (d.getDay() === 1 && i > 1) {
          weeks.push({ start: weekStart, end: i - 1 });
          weekStart = i;
        }
      }
      weeks.push({ start: weekStart, end: daysInMonth });

      weeksContainer.innerHTML = weeks.map((w, idx) => {
        let weekDays = 0;
        for (let i = w.start; i <= w.end; i++) {
          const d = new Date(year, month - 1, i);
          if (d.getDay() === 0) continue; // Skip Sunday
          const date = `${year}-${month}-${i.toString().padStart(2, '0')}`;
          const dayLeaves = leaves.filter(l => l.date === date);
          dayLeaves.forEach(l => {
            weekDays += l.timePeriod === 'full' ? 1 : 0.5;
          });
        }
        return `
          <div class="list-item">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div class="list-item-title">Tuáº§n ${idx + 1}</div>
                <div class="list-item-subtitle">${w.start}/${month} - ${w.end}/${month}</div>
              </div>
              <div style="text-align:right;">
                <span style="font-size:18px; font-weight:bold; color:#b45309;">${weekDays}</span>
                <span style="font-size:12px; color:#92400e;"> ngÃ y</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============ MANAGER EMPLOYEES ============
    function renderMgrEmployees() {
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const container = document.getElementById('mgr-employee-list');

      if (employees.length === 0) {
        container.innerHTML = '<div class="empty">ChÆ°a cÃ³ nhÃ¢n viÃªn nÃ o</div>';
        return;
      }

      container.innerHTML = employees.map(e => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${e.name}</span>
            <span class="badge">${e.department || 'N/A'}</span>
          </div>
          <div class="list-item-subtitle">@${e.username}</div>
          <div class="btn-row">
            <button class="btn btn-secondary btn-sm" onclick="editEmployee(${e.id})">âœï¸ Sá»­a</button>
            <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${e.id})">ğŸ—‘ï¸ XÃ³a</button>
          </div>
        </div>
      `).join('');
    }

    function openAddEmployeeModal() {
      editingEmployeeId = null;
      document.getElementById('emp-name').value = '';
      document.getElementById('emp-username').value = '';
      document.getElementById('emp-password').value = '';
      document.getElementById('emp-department').value = '';
      document.getElementById('modal-add-employee').classList.add('active');
    }

    function editEmployee(id) {
      const users = getUsers();
      const emp = users.find(u => u.id === id);
      if (!emp) return;

      editingEmployeeId = id;
      document.getElementById('emp-name').value = emp.name;
      document.getElementById('emp-username').value = emp.username;
      document.getElementById('emp-password').value = emp.password;
      document.getElementById('emp-department').value = emp.department || '';
      document.getElementById('modal-add-employee').classList.add('active');
    }

    async function saveEmployee() {
      const name = document.getElementById('emp-name').value.trim();
      const username = document.getElementById('emp-username').value.trim();
      const password = document.getElementById('emp-password').value;
      const department = document.getElementById('emp-department').value.trim();

      if (!name || !username || !password) {
        showToast('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin / è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      const users = getUsers();

      if (editingEmployeeId) {
        const idx = users.findIndex(u => u.id === editingEmployeeId);
        if (idx !== -1) {
          users[idx].name = name;
          users[idx].username = username;
          users[idx].password = password;
          users[idx].department = department;
          await saveUser(users[idx]);
        }
        showToast('ÄÃ£ cáº­p nháº­t nhÃ¢n viÃªn / å·²æ›´æ–°å‘˜å·¥ä¿¡æ¯');
      } else {
        const existing = users.find(u => u.username === username);
        if (existing) {
          showToast('TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i / ç”¨æˆ·åå·²å­˜åœ¨');
          return;
        }
        const newUser = {
          id: Date.now(),
          username,
          password,
          name,
          role: 'employee',
          department
        };
        await saveUser(newUser);
        showToast('ÄÃ£ thÃªm nhÃ¢n viÃªn má»›i / å·²æ·»åŠ æ–°å‘˜å·¥');
      }

      closeModal('modal-add-employee');
      renderMgrEmployees();
      renderMgrHome();
    }

    async function deleteEmployee(id) {
      if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a nhÃ¢n viÃªn nÃ y? / ç¡®å®šè¦åˆ é™¤æ­¤å‘˜å·¥å—?')) return;
      await deleteUserFromFirebase(id);
      showToast('ÄÃ£ xÃ³a nhÃ¢n viÃªn / å·²åˆ é™¤å‘˜å·¥');
      renderMgrEmployees();
      renderMgrHome();
    }

    // ============ MANAGER ATTENDANCE ============
    function renderAttendance() {
      const month = document.getElementById('attendance-month').value;
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const leaves = getLeaves().filter(l => l.date.startsWith(month) && l.status === 'approved');
      const container = document.getElementById('mgr-attendance-list');

      const data = employees.map(emp => {
        const empLeaves = leaves.filter(l => l.userId === emp.id);
        let leaveDays = 0;
        empLeaves.forEach(l => {
          if (l.timePeriod === 'full') leaveDays += 1;
          else leaveDays += 0.5;
        });
        return { ...emp, leaveDays, workDays: 26 - leaveDays };
      });

      container.innerHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>NhÃ¢n viÃªn</th>
                <th>NgÃ y lÃ m</th>
                <th>NgÃ y nghá»‰</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(d => `
                <tr>
                  <td>${d.name}</td>
                  <td>${d.workDays}</td>
                  <td>${d.leaveDays}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ============ MANAGER MEALS ============
    // Logic: Äi lÃ m = máº·c Ä‘á»‹nh cÃ³ cÆ¡m. Chá»‰ hiá»ƒn thá»‹ ai há»§y cÆ¡m.
    function renderMgrMeals() {
      const selectedDate = document.getElementById('meal-mgr-date').value;
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const meals = getMeals();
      const container = document.getElementById('mgr-meal-list');

      // Build meal status for each employee
      const data = employees.map(emp => {
        let status = 'registered'; // Máº·c Ä‘á»‹nh: cÃ³ cÆ¡m (Ä‘i lÃ m)
        let statusText = 'CÃ³ cÆ¡m';
        let reason = '';

        // Check if employee has meal record for this date
        const empMealKeys = Object.keys(meals).filter(k => {
          const m = meals[k];
          return m.date === selectedDate && m.userId === emp.id;
        });

        if (empMealKeys.length > 0) {
          const empMeal = meals[empMealKeys[0]];
          if (empMeal.registered === false) {
            status = 'cancelled';
            statusText = empMeal.cancelledByLeave ? 'Cáº¯t cÆ¡m (nghá»‰ phÃ©p)' : 'Há»§y cÆ¡m';
            reason = empMeal.cancelReason || '';
          }
        }

        return { ...emp, status, statusText, reason };
      });

      // Update stats
      const registered = data.filter(d => d.status === 'registered').length;
      const cancelled = data.filter(d => d.status === 'cancelled').length;
      document.getElementById('stat-meal-registered').textContent = registered;
      document.getElementById('stat-meal-cancelled').textContent = cancelled;

      if (data.length === 0) {
        container.innerHTML = '<div class="empty">ChÆ°a cÃ³ nhÃ¢n viÃªn nÃ o</div>';
        return;
      }

      container.innerHTML = data.map(d => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${d.name}</span>
            <span class="badge ${d.status === 'registered' ? 'badge-approved' : d.status === 'cancelled' ? 'badge-rejected' : 'badge-pending'}">${d.statusText}</span>
          </div>
          <div class="list-item-subtitle">${d.department || 'N/A'}</div>
          ${d.reason ? '<div class="text-small text-orange">' + d.reason + '</div>' : ''}
        </div>
      `).join('');
    }

    // Switch meal report tabs
    function switchMealReportTab(tab, btn) {
      // Update tabs
      document.querySelectorAll('#page-mgr-meals .tabs .tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      // Show/hide sections
      document.getElementById('meal-report-day').style.display = tab === 'day' ? 'block' : 'none';
      document.getElementById('meal-report-week').style.display = tab === 'week' ? 'block' : 'none';
      document.getElementById('meal-report-month').style.display = tab === 'month' ? 'block' : 'none';

      // Initialize data
      if (tab === 'week') {
        const now = new Date();
        const year = now.getFullYear();
        const week = getWeekNumber(now);
        document.getElementById('meal-mgr-week').value = `${year}-W${week.toString().padStart(2, '0')}`;
        renderMgrMealsWeek();
      } else if (tab === 'month') {
        document.getElementById('meal-mgr-month').value = getCurrentMonth();
        renderMgrMealsMonth();
      }
    }

    // Get week number from date
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // Get dates in a week from week string (e.g., "2024-W01")
    function getWeekDates(weekStr) {
      const [year, week] = weekStr.split('-W');
      const dates = [];
      const jan1 = new Date(parseInt(year), 0, 1);
      const days = (parseInt(week) - 1) * 7;
      const weekStart = new Date(jan1.getTime() + days * 24 * 60 * 60 * 1000);

      // Adjust to Monday
      const dayOfWeek = weekStart.getDay();
      const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      weekStart.setDate(weekStart.getDate() + diff);

      for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        dates.push(d.toISOString().split('T')[0]);
      }
      return dates;
    }

    // Get meal count for a specific date
    function getMealCountForDate(date) {
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const meals = getMeals();

      let count = employees.length;
      Object.values(meals).forEach(m => {
        if (m.date === date && m.registered === false) {
          count--;
        }
      });
      return count;
    }

    // Render week meal report
    function renderMgrMealsWeek() {
      const weekStr = document.getElementById('meal-mgr-week').value;
      if (!weekStr) return;

      const dates = getWeekDates(weekStr);
      const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
      const container = document.getElementById('mgr-meal-week-list');

      // Calculate total (exclude Sunday - day 0)
      let total = 0;
      const dailyData = [];
      dates.forEach(date => {
        const d = new Date(date);
        if (d.getDay() === 0) return; // Skip Sunday
        const dayName = dayNames[d.getDay()];
        const count = getMealCountForDate(date);
        total += count;
        dailyData.push({ date, dayName, count });
      });

      document.getElementById('stat-week-total').textContent = total;
      // Show Mon-Sat range
      const monDate = dates.find(d => new Date(d).getDay() === 1);
      const satDate = dates.find(d => new Date(d).getDay() === 6);
      document.getElementById('week-date-range').textContent = `${formatDate(monDate)} - ${formatDate(satDate)}`;

      container.innerHTML = dailyData.map(d => `
        <div class="list-item">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="list-item-title">${d.dayName}, ${formatDate(d.date)}</div>
            </div>
            <div style="text-align:right;">
              <span style="font-size:18px; font-weight:bold; color:#2563eb;">${d.count}</span>
              <span style="font-size:12px; color:#6b7280;"> suáº¥t</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Render month meal report
    function renderMgrMealsMonth() {
      const monthStr = document.getElementById('meal-mgr-month').value;
      if (!monthStr) return;

      const [year, month] = monthStr.split('-');
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const meals = getMeals();
      const container = document.getElementById('mgr-meal-month-list');
      const weeksContainer = document.getElementById('mgr-meal-month-weeks');

      // Get all dates in month (exclude Sundays)
      const daysInMonth = new Date(year, month, 0).getDate();
      const dates = [];
      for (let i = 1; i <= daysInMonth; i++) {
        const d = new Date(year, month - 1, i);
        if (d.getDay() !== 0) { // Skip Sunday
          dates.push(`${year}-${month}-${i.toString().padStart(2, '0')}`);
        }
      }

      // Calculate total and per-employee stats
      let total = 0;
      const empStats = {};
      employees.forEach(emp => {
        empStats[emp.id] = { name: emp.name, department: emp.department, count: 0 };
      });

      dates.forEach(date => {
        employees.forEach(emp => {
          // Check if cancelled
          const empMealKeys = Object.keys(meals).filter(k => {
            const m = meals[k];
            return m.date === date && m.userId === emp.id;
          });

          let isCancelled = false;
          if (empMealKeys.length > 0) {
            const empMeal = meals[empMealKeys[0]];
            if (empMeal.registered === false) {
              isCancelled = true;
            }
          }

          if (!isCancelled) {
            empStats[emp.id].count++;
            total++;
          }
        });
      });

      const monthNames = ['', 'ThÃ¡ng 1', 'ThÃ¡ng 2', 'ThÃ¡ng 3', 'ThÃ¡ng 4', 'ThÃ¡ng 5', 'ThÃ¡ng 6',
                          'ThÃ¡ng 7', 'ThÃ¡ng 8', 'ThÃ¡ng 9', 'ThÃ¡ng 10', 'ThÃ¡ng 11', 'ThÃ¡ng 12'];
      document.getElementById('stat-month-total').textContent = total;
      document.getElementById('month-name').textContent = `${monthNames[parseInt(month)]}/${year}`;

      // Render employee stats
      const empList = Object.values(empStats).sort((a, b) => b.count - a.count);
      container.innerHTML = empList.map(e => `
        <div class="list-item">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="list-item-title">${e.name}</div>
              <div class="list-item-subtitle">${e.department || 'N/A'}</div>
            </div>
            <div style="text-align:right;">
              <span style="font-size:18px; font-weight:bold; color:#2563eb;">${e.count}</span>
              <span style="font-size:12px; color:#6b7280;"> suáº¥t</span>
            </div>
          </div>
        </div>
      `).join('');

      // Render weekly breakdown
      const weeks = [];
      let weekStart = 0;
      for (let i = 0; i < daysInMonth; i++) {
        const d = new Date(year, month - 1, i + 1);
        if (d.getDay() === 1 || i === 0) {
          if (i > 0) {
            weeks.push({ start: weekStart, end: i });
          }
          weekStart = i + 1;
        }
      }
      weeks.push({ start: weekStart, end: daysInMonth });

      weeksContainer.innerHTML = weeks.map((w, idx) => {
        let weekTotal = 0;
        for (let i = w.start; i <= w.end; i++) {
          const d = new Date(year, month - 1, i);
          if (d.getDay() === 0) continue; // Skip Sunday
          const date = `${year}-${month}-${i.toString().padStart(2, '0')}`;
          weekTotal += getMealCountForDate(date);
        }
        return `
          <div class="list-item">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div class="list-item-title">Tuáº§n ${idx + 1}</div>
                <div class="list-item-subtitle">${w.start}/${month} - ${w.end}/${month}</div>
              </div>
              <div style="text-align:right;">
                <span style="font-size:18px; font-weight:bold; color:#2563eb;">${weekTotal}</span>
                <span style="font-size:12px; color:#6b7280;"> suáº¥t</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============ KITCHEN ============
    function showKitchenPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('#kitchen-nav .nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById('page-kitchen-' + page).classList.add('active');
      const navItem = document.getElementById('kitchen-nav-' + page);
      if (navItem) navItem.classList.add('active');

      if (page === 'home') renderKitchenHome();
      if (page === 'meals') renderKitchenMeals();
      if (page === 'leaves') renderKitchenLeaves();
    }

    function renderKitchenHome() {
      const today = getToday();
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const meals = getMeals();
      const leaves = getLeaves();

      // Format today's date
      const todayDate = new Date();
      const dayNames = ['Chá»§ nháº­t', 'Thá»© 2', 'Thá»© 3', 'Thá»© 4', 'Thá»© 5', 'Thá»© 6', 'Thá»© 7'];
      const formattedDate = dayNames[todayDate.getDay()] + ', ' + formatDate(today);
      document.getElementById('kitchen-today-date').textContent = formattedDate;

      // Count today's approved leaves (full day only)
      const todayLeaves = leaves.filter(l => l.date === today && l.status === 'approved');
      const fullDayLeaves = todayLeaves.filter(l => l.timePeriod === 'full').length;

      // Count cancelled meals (ngÆ°á»i há»§y cÆ¡m chá»§ Ä‘á»™ng)
      const cancelledMeals = Object.values(meals).filter(m => m.date === today && m.registered === false);

      // TÃ­nh suáº¥t cÆ¡m thá»±c táº¿: Tá»•ng NV - Nghá»‰ cáº£ ngÃ y - Há»§y cÆ¡m
      const totalEmployees = employees.length;
      const finalMeals = totalEmployees - fullDayLeaves - cancelledMeals.length;

      document.getElementById('kitchen-final-meals').textContent = finalMeals;
      document.getElementById('kitchen-calc-detail').textContent =
        `${totalEmployees} nhÃ¢n viÃªn/å‘˜å·¥ - ${fullDayLeaves} nghá»‰/è¯·å‡ - ${cancelledMeals.length} há»§y cÆ¡m/å–æ¶ˆ`;
    }

    function renderKitchenMeals() {
      const today = getToday();
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const meals = getMeals();
      const container = document.getElementById('kitchen-meal-list');

      document.getElementById('kitchen-meals-date').textContent = formatDate(today);

      // Build list of employees eating today (default: cÃ³ cÆ¡m, except cancelled)
      const eatingList = [];
      employees.forEach(emp => {
        // Check if employee cancelled meal
        const empMealKeys = Object.keys(meals).filter(k => {
          const m = meals[k];
          return m.date === today && m.userId === emp.id;
        });

        let isCancelled = false;
        if (empMealKeys.length > 0) {
          const empMeal = meals[empMealKeys[0]];
          if (empMeal.registered === false) {
            isCancelled = true;
          }
        }

        if (!isCancelled) {
          eatingList.push(emp);
        }
      });

      document.getElementById('kitchen-meals-total').textContent = eatingList.length;

      if (eatingList.length === 0) {
        container.innerHTML = '<div class="empty">KhÃ´ng cÃ³ ai Äƒn cÆ¡m hÃ´m nay</div>';
        return;
      }

      container.innerHTML = eatingList.map((emp, idx) => `
        <div class="list-item">
          <div style="display:flex; align-items:center;">
            <div style="width:30px; height:30px; background:#dcfce7; color:#166534; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:12px;">${idx + 1}</div>
            <div>
              <div class="list-item-title">${emp.name}</div>
              <div class="list-item-subtitle">${emp.department || 'N/A'}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderKitchenLeaves() {
      const today = getToday();
      const leaves = getLeaves().filter(l => l.date === today && l.status === 'approved');
      const container = document.getElementById('kitchen-leave-list');

      document.getElementById('kitchen-leaves-date').textContent = formatDate(today);
      document.getElementById('kitchen-leaves-total').textContent = leaves.length;

      if (leaves.length === 0) {
        container.innerHTML = '<div class="empty">KhÃ´ng cÃ³ ai nghá»‰ hÃ´m nay</div>';
        return;
      }

      container.innerHTML = leaves.map(l => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${l.userName}</span>
            <span class="badge badge-rejected">${l.timePeriod === 'full' ? 'Cáº£ ngÃ y' : l.timePeriod === 'morning' ? 'SÃ¡ng' : 'Chiá»u'}</span>
          </div>
          ${l.reason ? '<div class="text-small">' + l.reason + '</div>' : ''}
          ${l.mealCancelled ? '<div class="text-small text-orange">ğŸš Cáº¯t cÆ¡m</div>' : ''}
        </div>
      `).join('');
    }

    function sendMealReport() {
      const today = getToday();
      const users = getUsers();
      const employees = users.filter(u => u.role === 'employee');
      const meals = getMeals();
      const leaves = getLeaves();

      // Build eating list
      const eatingList = [];
      employees.forEach(emp => {
        const empMealKeys = Object.keys(meals).filter(k => {
          const m = meals[k];
          return m.date === today && m.userId === emp.id;
        });

        let isCancelled = false;
        if (empMealKeys.length > 0) {
          const empMeal = meals[empMealKeys[0]];
          if (empMeal.registered === false) {
            isCancelled = true;
          }
        }

        if (!isCancelled) {
          eatingList.push(emp);
        }
      });

      // Build leaves list
      const todayLeaves = leaves.filter(l => l.date === today && l.status === 'approved');

      // Format report
      const todayDate = new Date();
      const dayNames = ['Chá»§ nháº­t', 'Thá»© 2', 'Thá»© 3', 'Thá»© 4', 'Thá»© 5', 'Thá»© 6', 'Thá»© 7'];
      const formattedDate = dayNames[todayDate.getDay()] + ', ' + formatDate(today);

      let report = `ğŸš BÃO CÆ M ${formattedDate}\n\n`;
      report += `ğŸ“Š Tá»•ng: ${eatingList.length} suáº¥t cÆ¡m\n\n`;
      report += `ğŸ“‹ DANH SÃCH Ä‚N CÆ M:\n`;
      eatingList.forEach((emp, idx) => {
        report += `${idx + 1}. ${emp.name}\n`;
      });

      if (todayLeaves.length > 0) {
        report += `\nğŸ“… NGHá»ˆ HÃ”M NAY (${todayLeaves.length} ngÆ°á»i):\n`;
        todayLeaves.forEach(l => {
          const period = l.timePeriod === 'full' ? 'cáº£ ngÃ y' : l.timePeriod === 'morning' ? 'sÃ¡ng' : 'chiá»u';
          report += `- ${l.userName} (${period})\n`;
        });
      }

      // Copy to clipboard and show alert
      if (navigator.clipboard) {
        navigator.clipboard.writeText(report).then(() => {
          showToast('ÄÃ£ copy bÃ¡o cÃ¡o! / å·²å¤åˆ¶æŠ¥å‘Š!');
        }).catch(() => {
          alert(report);
        });
      } else {
        alert(report);
      }

      // Save last report time
      localStorage.setItem('lastMealReport', new Date().toISOString());
      console.log('Meal report sent:', report);
    }

    // Auto send meal report at 6:00 AM
    function checkAutoMealReport() {
      const now = new Date();
      const today = getToday();
      const lastReport = localStorage.getItem('lastMealReportDate');

      // Only send if it's past 6:00 AM and haven't sent today
      if (now.getHours() >= 6 && lastReport !== today) {
        // Mark as sent for today
        localStorage.setItem('lastMealReportDate', today);
        // Auto send
        if (currentUser && currentUser.role === 'kitchen') {
          sendMealReport();
        }
      }
    }

    // ============ INIT ============
    document.addEventListener('DOMContentLoaded', async function() {
      log('ğŸ“± DOM Ready');

      // Hiá»ƒn thá»‹ login page ngay láº­p tá»©c
      document.getElementById('login-page').classList.add('active');
      log('âœ… Login page displayed');

      // Khá»Ÿi táº¡o Firebase REST API vÃ  load data
      try {
        log('ğŸ”„ Initializing Firebase REST API...');
        await initFirebaseData();
        log('âœ… initFirebaseData done');
        await loadUsersFromFirebase();
        log('âœ… loadUsersFromFirebase done, count: ' + cachedUsers.length);
        await loadLeavesFromFirebase();
        log('âœ… loadLeavesFromFirebase done, count: ' + cachedLeaves.length);
        await loadMealsFromFirebase();
        log('âœ… loadMealsFromFirebase done');
        startDataSync();
        log('âœ… Firebase Ready!');
      } catch (e) {
        log('âŒ Firebase init error: ' + e.message);
        cachedUsers = DEFAULT_USERS;
      }

      // Check if user is already logged in
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        log('ğŸ‘¤ Found saved user');
        currentUser = JSON.parse(savedUser);
        const users = getUsers();
        const exists = users.find(u => u.id === currentUser.id);
        if (exists) {
          currentUser = exists;
          showApp();
          if (currentUser.role === 'kitchen') {
            checkAutoMealReport();
          }
        } else {
          localStorage.removeItem('currentUser');
        }
      }
      log('ğŸ‰ APP LOADED!');

      // Check auto report every minute (for kitchen users)
      setInterval(() => {
        if (currentUser && currentUser.role === 'kitchen') {
          checkAutoMealReport();
        }
      }, 60000);
    });
  </script>
</body>
</html>
