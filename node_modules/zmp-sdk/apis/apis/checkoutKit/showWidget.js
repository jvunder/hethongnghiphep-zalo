import e from'./../../external/@swc/helpers/src/_async_to_generator.mjs.js';import t from'./../../external/@swc/helpers/src/_object_without_properties.mjs.js';import n from'./../../external/@swc/helpers/src/_sliced_to_array.mjs.js';import o from'./../../external/@swc/helpers/src/_to_consumable_array.mjs.js';import r,{object as s,string as a}from'./../../external/zod/lib/index.mjs.js';import i from"../../appEnv/index.js";import c from"../../common/notFound.js";import{functionHandler as m}from"../../utils/decorator.js";import l from"../../common/token.js";import u from"../../common/call/index.js";import{setSearchParams as d,postMessageToWidget as p}from"../../utils/common.js";import{CHECKOUT_KIT_WIDGET_ID as f,WIDGET_URLS as h,ALLOW_WIDGET_ORIGIN as g}from"../../constants.js";import{getZaloVersionCode as j}from"../../common/utils.js";import{__generator as y}from'./../../external/tslib/tslib.es6.js';import v from"../../appEnv/getEnv.js";var w,_=[s({id:a(),onMethodChange:r.function().optional()}).catchall(r.any())];function b(e){return E.apply(this,arguments)}function E(){return E=e((function(r){return y(this,(function(s){return[2,m("showWidget",_,[r],(a=e((function(r){var s,a,m,_,b,E,C,I,P,M,L,N;return y(this,(function(T){if(i.isMp){try{s=document.getElementById(r.id),a=r.onMethodChange,m=r.fail,_=t(r,["onMethodChange","fail"]),s&&((b=document.getElementById(f))&&(null==b||null===(E=b.parentNode)||void 0===E||E.removeChild(b),b=null),b=document.createElement("iframe"),C=f,I=new URL(h.CHECKOUT_KIT),P={id:C,appId:window.APP_ID},Object.entries(_).forEach((function(e){var t=n(e,2),o=t[0],r=t[1];r&&(P["data-".concat(o)]=r)})),M=JSON.stringify(P),L=btoa(M),N=encodeURIComponent(L),d(I.searchParams,"data",N),b.id=C,b.src=I.href,b.style.width="100%",b.style.height="100%",b.style.border="none",s.innerHTML=b.outerHTML,window.removeEventListener("message",w,!1),w=function(){var t=e((function(e){var t,n,r,s,i,c,d,f,h,w;return y(this,(function(y){switch(y.label){case 0:if(t=e.data,!e.origin.startsWith(g))return[3,9];if(n=t.type,r=document.getElementById(C),(s=new URL(t.href)).origin!==I.origin||s.pathname!==I.pathname||t.id!==C)return[3,9];switch(n){case"getInfo":return[3,1];case"getToken":return[3,2];case"heightChange":return[3,4];case"callAction":return[3,5];case"onMethodChange":return[3,6];case"onError":return[3,7]}return[3,8];case 1:return p(r,n,{appId:window.APP_ID,zaloVersion:j(),appPlatform:null===(i=v())||void 0===i?void 0:i.platformName}),[3,9];case 2:return[4,l.jumpAndGetToken()];case 3:return y.sent(),d=null===(c=l.miniProgramConfig)||void 0===c?void 0:c.jwt,p(r,n,{jwt:d}),[3,9];case 4:return r.style.height="".concat(t.payload,"px"),[3,9];case 5:return f=t.payload,h=f.actionName,w=f.actionData,String(h).length>0&&u(h,w,{success:function(e){p(r,n,{status:0,actionName:h,data:e})},fail:function(e){p(r,n,{status:-1,actionName:h,data:e})}},{}),[3,9];case 6:return null==a||a.apply(void 0,o(Object.values(t.payload))),[3,9];case 7:null==m||m(t.payload),y.label=8;case 8:return[3,9];case 9:return[2]}}))}));return function(e){return t.apply(this,arguments)}}(),window.addEventListener("message",w,!1))}catch(e){console.log(e)}return[2,Promise.resolve()]}return i.isMpWeb?[2,Promise.resolve()]:[2,Promise.reject(c("showWidget",{}))]}))})),function(e){return a.apply(this,arguments)}))];var a}))})),E.apply(this,arguments)}export{b as showWidget};
